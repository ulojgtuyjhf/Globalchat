
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TikTok-like Feed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
        }

        body, html {
            height: 100%;
            width: 100%;
            background-color: #000;
            color: #fff;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #video-feed {
            width: 100%;
            height: 100vh;
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
            overflow-x: hidden;
            scrollbar-width: none;
        }

        #video-feed::-webkit-scrollbar {
            display: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100vh;
            scroll-snap-align: start;
            scroll-snap-stop: always;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #555;
            margin-right: 10px;
            object-fit: cover;
            border: 2px solid #fff;
        }

        .username {
            font-weight: bold;
            font-size: 16px;
        }

        .video-description {
            font-size: 14px;
            margin-bottom: 15px;
            max-width: 80%;
        }

        .video-actions {
            position: absolute;
            right: 20px;
            bottom: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
        }

        .action-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .action-count {
            font-size: 12px;
        }

        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .nav-button {
            padding: 0 15px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
        }

        .nav-button.active {
            color: #fff;
        }

        .plus-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #fe2c55;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            text-align: center;
            padding: 20px;
        }

        .empty-icon {
            font-size: 50px;
            margin-bottom: 20px;
            color: #aaa;
        }

        .empty-text {
            font-size: 18px;
            color: #aaa;
            max-width: 300px;
        }

        .image-post {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000;
        }

        /* Handle image posts differently */
        .image-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="app-container">
        
        <div id="video-feed"></div>

        

        <div class="loading-container" id="loading">
            <div class="spinner"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy, limit, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDnPz8BWCaXJOazlFVO4Eap8VxdSR2oDFQ",
            authDomain: "globalchat-2d669.firebaseapp.com",
            projectId: "globalchat-2d669",
            storageBucket: "globalchat-2d669.firebasestorage.app",
            messagingSenderId: "178714711978",
            appId: "1:178714711978:web:fb831188be23e62a4bbdd3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const videoFeed = document.getElementById('video-feed');
        const loadingElement = document.getElementById('loading');
        let currentlyPlaying = null;
        let userProfiles = {}; // Cache for user profiles

        // Check if user is authenticated
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                await loadPosts();
            } else {
                // User is signed out, redirect to login
                window.location.href = 'login.html';
            }
        });

        async function loadPosts() {
            try {
                // Query the posts collection
                const postsQuery = query(
                    collection(db, 'posts'),
                    orderBy('createdAt', 'desc'),
                    limit(20)
                );
                
                const postsSnapshot = await getDocs(postsQuery);
                
                if (postsSnapshot.empty) {
                    showEmptyState();
                } else {
                    for (const postDoc of postsSnapshot.docs) {
                        const postData = postDoc.data();
                        await createPostElement(postData, postDoc.id);
                    }
                    
                    // Setup intersection observer after posts are loaded
                    setupIntersectionObserver();
                }
                
                // Hide loading spinner
                loadingElement.style.display = 'none';
                
            } catch (error) {
                console.error("Error loading posts:", error);
                loadingElement.style.display = 'none';
                showErrorState();
            }
        }

        async function getUserProfile(userId) {
            // Check cache first
            if (userProfiles[userId]) {
                return userProfiles[userId];
            }
            
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userProfiles[userId] = userData; // Cache the profile
                    return userData;
                } else {
                    return {
                        displayName: "Anonymous User",
                        photoURL: null
                    };
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                return {
                    displayName: "Unknown User",
                    photoURL: null
                };
            }
        }

        async function createPostElement(postData, postId) {
            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = `post-${postId}`;
            
            // Get user profile
            const userProfile = await getUserProfile(postData.userId);
            
            // Determine if it's a video or an image
            const isVideo = postData.mediaType && postData.mediaType.startsWith('video/');
            const isImage = postData.mediaType && postData.mediaType.startsWith('image/');
            
            if (isVideo && postData.mediaUrl) {
                // Create video player
                const videoPlayer = document.createElement('video');
                videoPlayer.className = 'video-player';
                videoPlayer.src = postData.mediaUrl;
                videoPlayer.setAttribute('playsinline', '');
                videoPlayer.setAttribute('webkit-playsinline', '');
                videoPlayer.muted = false;
                videoPlayer.loop = true;
                videoPlayer.preload = 'auto';
                
                container.appendChild(videoPlayer);
            } else if (isImage && postData.mediaUrl) {
                // Create image container
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                
                const imageElement = document.createElement('img');
                imageElement.className = 'image-post';
                imageElement.src = postData.mediaUrl;
                imageElement.alt = 'Post image';
                
                imageContainer.appendChild(imageElement);
                container.appendChild(imageContainer);
            } else {
                // Text-only post
                const textContainer = document.createElement('div');
                textContainer.className = 'image-container';
                textContainer.style.backgroundColor = '#111';
                
                const textElement = document.createElement('div');
                textElement.className = 'video-description';
                textElement.style.fontSize = '24px';
                textElement.style.maxWidth = '90%';
                textElement.textContent = postData.text || "No content";
                
                textContainer.appendChild(textElement);
                container.appendChild(textContainer);
            }
            
            // Create overlay with user info
            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';
            
            // User info section
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            
            const profilePic = document.createElement('img');
            profilePic.className = 'profile-pic';
            profilePic.src = userProfile.photoURL || 'https://via.placeholder.com/50';
            profilePic.alt = 'Profile picture';
            
            const username = document.createElement('div');
            username.className = 'username';
            username.textContent = userProfile.displayName || 'Anonymous';
            
            userInfo.appendChild(profilePic);
            userInfo.appendChild(username);
            
            // Video description
            const description = document.createElement('div');
            description.className = 'video-description';
            description.textContent = postData.text || '';
            
            overlay.appendChild(userInfo);
            overlay.appendChild(description);
            
            // Action buttons
            const actions = document.createElement('div');
            actions.className = 'video-actions';
            
            // Like button
            const likeButton = createActionButton('heart', Math.floor(Math.random() * 1000));
            // Share button
            const shareButton = createActionButton('share', Math.floor(Math.random() * 100));
            // Comment button
            const commentButton = createActionButton('comment', Math.floor(Math.random() * 500));
            
            actions.appendChild(likeButton);
            actions.appendChild(commentButton);
            actions.appendChild(shareButton);
            
            container.appendChild(overlay);
            container.appendChild(actions);
            
            videoFeed.appendChild(container);
        }

        function createActionButton(iconName, count) {
            const button = document.createElement('div');
            button.className = 'action-button';
            
            const icon = document.createElement('div');
            icon.className = 'action-icon';
            icon.innerHTML = `<i class="fas fa-${iconName}"></i>`;
            
            const countElement = document.createElement('div');
            countElement.className = 'action-count';
            countElement.textContent = formatCount(count);
            
            button.appendChild(icon);
            button.appendChild(countElement);
            
            return button;
        }

        function formatCount(count) {
            if (count >= 1000000) {
                return (count / 1000000).toFixed(1) + 'M';
            } else if (count >= 1000) {
                return (count / 1000).toFixed(1) + 'K';
            }
            return count.toString();
        }

        function setupIntersectionObserver() {
            const options = {
                root: videoFeed,
                rootMargin: '0px',
                threshold: 0.8
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const container = entry.target;
                    const videoElement = container.querySelector('video');
                    
                    if (entry.isIntersecting) {
                        if (videoElement) {
                            // Pause currently playing video if it's different
                            if (currentlyPlaying && currentlyPlaying !== videoElement) {
                                currentlyPlaying.pause();
                            }
                            
                            // Play the new video
                            videoElement.play().catch(error => {
                                console.error("Error playing video:", error);
                                // Create play button overlay if autoplay is prevented
                                if (!container.querySelector('.play-overlay')) {
                                    createPlayOverlay(container, videoElement);
                                }
                            });
                            
                            currentlyPlaying = videoElement;
                        }
                    } else {
                        if (videoElement) {
                            videoElement.pause();
                            if (currentlyPlaying === videoElement) {
                                currentlyPlaying = null;
                            }
                        }
                    }
                });
            }, options);
            
            // Observe all video containers
            document.querySelectorAll('.video-container').forEach(container => {
                observer.observe(container);
            });
            
            // Handle scroll events to ensure the right video is playing
            videoFeed.addEventListener('scroll', () => {
                // Small delay to let the scroll settle
                setTimeout(() => {
                    const visibleElements = Array.from(document.querySelectorAll('.video-container')).filter(el => {
                        const rect = el.getBoundingClientRect();
                        return rect.top >= 0 && rect.top <= window.innerHeight / 2;
                    });
                    
                    if (visibleElements.length > 0) {
                        const visibleContainer = visibleElements[0];
                        const videoElement = visibleContainer.querySelector('video');
                        
                        if (videoElement) {
                            // Pause currently playing if different
                            if (currentlyPlaying && currentlyPlaying !== videoElement) {
                                currentlyPlaying.pause();
                            }
                            
                            // Play the visible video
                            videoElement.play().catch(console.error);
                            currentlyPlaying = videoElement;
                        }
                    }
                }, 100);
            });
        }

        function createPlayOverlay(container, videoElement) {
            const playOverlay = document.createElement('div');
            playOverlay.className = 'play-overlay';
            playOverlay.style.position = 'absolute';
            playOverlay.style.top = '0';
            playOverlay.style.left = '0';
            playOverlay.style.width = '100%';
            playOverlay.style.height = '100%';
            playOverlay.style.display = 'flex';
            playOverlay.style.justifyContent = 'center';
            playOverlay.style.alignItems = 'center';
            playOverlay.style.backgroundColor = 'rgba(0,0,0,0.3)';
            playOverlay.style.zIndex = '5';
            playOverlay.style.cursor = 'pointer';
            
            const playIcon = document.createElement('i');
            playIcon.className = 'fas fa-play';
            playIcon.style.fontSize = '48px';
            playIcon.style.color = 'white';
            
            playOverlay.appendChild(playIcon);
            container.appendChild(playOverlay);
            
            playOverlay.addEventListener('click', () => {
                videoElement.play().then(() => {
                    playOverlay.remove();
                    currentlyPlaying = videoElement;
                }).catch(console.error);
            });
        }

        function showEmptyState() {
            videoFeed.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-video-slash"></i>
                    </div>
                    <div class="empty-text">
                        No videos yet. Be the first to upload!
                    </div>
                </div>
            `;
        }

        function showErrorState() {
            videoFeed.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="empty-text">
                        Something went wrong while loading videos. Please try again later.
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>

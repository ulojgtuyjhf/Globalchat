
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalChat</title>
    <style>
        :root {
            --primary-color: #1DA1F2;
            --background-color: #15202b;
            --timeline-bg: #192734;
            --text-color: #ffffff;
            --secondary-text: #8899a6;
            --border-color: #38444d;
            --button-hover: rgba(29, 161, 242, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: var(--background-color);
            height: 100vh;
            width: 100%;
            color: var(--text-color);
            overflow: hidden;
        }

        .chat-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--background-color);
            max-width: 600px;
            margin: 0 auto;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            background: var(--background-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--background-color);
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .message-wrapper {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            animation: fadeIn 0.3s ease;
        }

        .message-avatar {
            margin-right: 12px;
        }

        .message-avatar img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
        }

        .message-name {
            font-weight: 700;
            font-size: 15px;
            margin-right: 5px;
            color: var(--text-color);
        }

        .message-username, .message-time {
            color: var(--secondary-text);
            font-size: 14px;
        }

        .message-username {
            margin-right: 8px;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            margin-bottom: 10px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-media {
            border-radius: 16px;
            overflow: hidden;
            margin-top: 10px;
            max-width: 100%;
        }

        .message-media img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            display: block;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .message-media img:hover {
            opacity: 0.9;
        }

        .message-media video {
            max-width: 100%;
            max-height: 400px;
            display: block;
            background: #000;
        }

        .action-buttons {
            display: flex;
            margin-top: 8px;
        }

        .action-button {
            display: flex;
            align-items: center;
            margin-right: 24px;
            color: var(--secondary-text);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: color 0.2s;
        }

        .action-button:hover {
            color: var(--primary-color);
        }

        .action-button svg {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            fill: currentColor;
        }

        .chat-input-container {
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            background: var(--background-color);
        }

        .media-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .media-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 16px;
            overflow: hidden;
        }

        .media-preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 14px;
            border: none;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--timeline-bg);
            border-radius: 9999px;
            padding: 10px 15px;
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: var(--text-color);
            font-size: 16px;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
            padding: 0;
        }

        .chat-input::placeholder {
            color: var(--secondary-text);
        }

        .chat-actions {
            display: flex;
            align-items: center;
        }

        .upload-btn {
            background: none;
            border: none;
            cursor: pointer;
            margin-right: 12px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-btn svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 9999px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 8px;
        }

        .send-btn:disabled {
            background-color: #1a608f;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .file-input {
            display: none;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            margin: 0 4px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: bounce 0.5s infinite alternate;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.1s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.2s;
        }

        /* Global loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(21, 32, 43, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }

        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .message-avatar img {
                width: 40px;
                height: 40px;
            }

            .message-wrapper {
                padding: 10px 0;
            }

            .action-button {
                margin-right: 16px;
            }

            .chat-input-wrapper {
                padding: 8px 12px;
            }

            .media-preview-item {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="loading-dots" id="loadingIndicator">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
            <!-- Messages will be inserted here dynamically -->
        </div>
        
        <div class="chat-input-container">
            <div class="media-preview" id="mediaPreview"></div>
            <div class="chat-input-wrapper">
                <textarea class="chat-input" id="messageInput" placeholder="What's happening?" rows="1"></textarea>
                <div class="chat-actions">
                    <button class="upload-btn" id="uploadBtn">
                        <svg viewBox="0 0 24 24">
                            <path d="M19.75 2H4.25C3.01 2 2 3.01 2 4.25v15.5C2 20.99 3.01 22 4.25 22h15.5c1.24 0 2.25-1.01 2.25-2.25V4.25C22 3.01 20.99 2 19.75 2zM4.25 3.5h15.5c.413 0 .75.337.75.75v9.676l-3.858-3.858c-.14-.14-.33-.22-.53-.22h-.003c-.2 0-.393.08-.532.224l-4.317 4.384-1.813-1.806c-.14-.14-.33-.22-.53-.22-.193-.03-.395.08-.535.227L3.5 17.642V4.25c0-.413.337-.75.75-.75zm-.744 16.28l5.418-5.534 6.282 6.254H4.25c-.402 0-.727-.322-.744-.72zm16.244.72h-2.42l-5.007-4.987 3.792-3.85 4.385 4.384v3.703c0 .413-.337.75-.75.75z"></path>
                            <circle cx="8.868" cy="8.309" r="1.542"></circle>
                        </svg>
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept="image/*, video/*">
                    <button class="send-btn" id="sendBtn" disabled>
                        <svg viewBox="0 0 24 24">
                            <path d="M2.252 6.456l19.476 5.825c.53.159.53.928 0 1.088L2.252 19.194c-.43.129-.81-.303-.53-.604l4.309-4.672c.45-.487.45-1.256 0-1.742L1.722 7.06c-.28-.302.1-.733.53-.604z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDnPz8BWCaXJOazlFVO4Eap8VxdSR2oDFQ",
    authDomain: "globalchat-2d669.firebaseapp.com",
    projectId: "globalchat-2d669",
    storageBucket: "globalchat-2d669.firebasestorage.app",
    messagingSenderId: "178714711978",
    appId: "1:178714711978:web:fb831188be23e62a4bbdd3",
    measurementId: "G-LYZP41ZJ46"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const firestore = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);

const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const mediaPreview = document.getElementById('mediaPreview');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingIndicator = document.getElementById('loadingIndicator');

let currentUser = null;
let userDetails = null;
let mediaFile = null;

// Auto-resize textarea
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    
    // Enable/disable send button based on content
    if (this.value.trim() || mediaFile) {
        sendBtn.removeAttribute('disabled');
    } else {
        sendBtn.setAttribute('disabled', 'true');
    }
});

// Format timestamp
const formatTime = (timestamp) => {
    const date = new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
};

// Format date for tweets
const formatDate = (timestamp) => {
    const date = new Date(timestamp);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return `${diffInSeconds}s`;
    } else if (diffInSeconds < 3600) {
        return `${Math.floor(diffInSeconds / 60)}m`;
    } else if (diffInSeconds < 86400) {
        return `${Math.floor(diffInSeconds / 3600)}h`;
    } else {
        return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }
};

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        try {
            const userDoc = await getDoc(doc(firestore, 'users', user.uid));
            if (userDoc.exists()) {
                userDetails = userDoc.data();
            }
            loadMessages();
        } catch (error) {
            console.error("Error fetching user data:", error);
        }
    } else {
        window.location.href = 'login.html';
    }
});

const loadMessages = () => {
    const messagesRef = query(ref(db, 'imageSharing'), orderByChild('timestamp'), limitToLast(50));
    
    // Show loading indicator
    if (loadingIndicator) {
        loadingIndicator.style.display = 'flex';
    }
    
    onChildAdded(messagesRef, (snapshot) => {
        const message = snapshot.val();
        displayMessage(message);
        
        // Hide loading indicator after the first message is loaded
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
    });
};

const displayMessage = (message) => {
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('message-wrapper');
    
    const avatarDiv = document.createElement('div');
    avatarDiv.classList.add('message-avatar');
    
    const avatarImg = document.createElement('img');
    avatarImg.src = message.photoURL || 'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png';
    avatarImg.alt = 'Profile';
    avatarDiv.appendChild(avatarImg);
    
    const contentDiv = document.createElement('div');
    contentDiv.classList.add('message-content');
    
    // Message header (name, username, time)
    const headerDiv = document.createElement('div');
    headerDiv.classList.add('message-header');
    
    const nameSpan = document.createElement('span');
    nameSpan.classList.add('message-name');
    nameSpan.textContent = message.username || 'Anonymous';
    headerDiv.appendChild(nameSpan);
    
    const usernameSpan = document.createElement('span');
    usernameSpan.classList.add('message-username');
    usernameSpan.textContent = `@${message.username?.toLowerCase().replace(/\s/g, '') || 'user'}`;
    headerDiv.appendChild(usernameSpan);
    
    const timeSpan = document.createElement('span');
    timeSpan.classList.add('message-time');
    timeSpan.textContent = `· ${formatDate(message.timestamp)}`;
    headerDiv.appendChild(timeSpan);
    
    contentDiv.appendChild(headerDiv);
    
    // Message text
    if (message.text && message.text.trim()) {
        const textDiv = document.createElement('div');
        textDiv.classList.add('message-text');
        textDiv.textContent = message.text;
        contentDiv.appendChild(textDiv);
    }
    
    // Message media (image or video)
    if (message.imageURL || message.videoURL) {
        const mediaDiv = document.createElement('div');
        mediaDiv.classList.add('message-media');
        
        if (message.imageURL) {
            const img = document.createElement('img');
            img.src = message.imageURL;
            img.alt = 'Shared image';
            img.loading = 'lazy';
            mediaDiv.appendChild(img);
        }
        
        if (message.videoURL) {
            const video = document.createElement('video');
            video.src = message.videoURL;
            video.controls = true;
            video.preload = 'metadata';
            mediaDiv.appendChild(video);
        }
        
        contentDiv.appendChild(mediaDiv);
    }
    
    // Add action buttons
    const actionButtons = document.createElement('div');
    actionButtons.classList.add('action-buttons');
    
    // Reply button
    const replyButton = document.createElement('button');
    replyButton.classList.add('action-button');
    replyButton.innerHTML = `
        <svg viewBox="0 0 24 24">
            <path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path>
        </svg>
    `;
    actionButtons.appendChild(replyButton);
    
    // Retweet button
    const retweetButton = document.createElement('button');
    retweetButton.classList.add('action-button');
    retweetButton.innerHTML = `
        <svg viewBox="0 0 24 24">
            <path d="M4.5 3.88l4.432 4.14-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zM16.5 6H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path>
        </svg>
    `;
    actionButtons.appendChild(retweetButton);
    
    // Like button
    const likeButton = document.createElement('button');
    likeButton.classList.add('action-button');
    likeButton.innerHTML = `
        <svg viewBox="0 0 24 24">
            <path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path>
        </svg>
    `;
    actionButtons.appendChild(likeButton);
    
    // Share button
    const shareButton = document.createElement('button');
    shareButton.classList.add('action-button');
    shareButton.innerHTML = `
        <svg viewBox="0 0 24 24">
            <path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59zM21 15l-.02 3.51c0 1.38-1.12 2.49-2.5 2.49H5.5C4.11 21 3 19.88 3 18.5V15h2v3.5c0 .28.22.5.5.5h12.98c.28 0 .5-.22.5-.5L19 15h2z"></path>
        </svg>
    `;
    actionButtons.appendChild(shareButton);
    
    contentDiv.appendChild(actionButtons);
    
    messageWrapper.appendChild(avatarDiv);
    messageWrapper.appendChild(contentDiv);
    
    chatMessages.appendChild(messageWrapper);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
};

// Upload button click handler
uploadBtn.addEventListener('click', () => {
    fileInput.click();
});

// File selection handler
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        mediaFile = file;
        
        // Create preview element
        mediaPreview.innerHTML = '';
        const previewItem = document.createElement('div');
        previewItem.classList.add('media-preview-item');
        
        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.classList.add('media-preview-image');
            
            const reader = new FileReader();
            reader.onload = (event) => {
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            
            previewItem.appendChild(img);
        } else if (file.type.startsWith('video/')) {
            const videoIconSvg = `
                <svg viewBox="0 0 24 24" width="100" height="100" fill="#1DA1F2">
                    <path d="M21 12l-18 12v-24z"/>
                </svg>
            `;
            previewItem.innerHTML = videoIconSvg;
        }
        
        // Add remove button
        const removeBtn = document.createElement('button');
        removeBtn.classList.add('media-preview-remove');
        removeBtn.textContent = '×';
        removeBtn.addEventListener('click', () => {
            mediaPreview.innerHTML = '';
            mediaFile = null;
            
            // Disable send button if there's no text
            if (!messageInput.value.trim()) {
                sendBtn.setAttribute('disabled', 'true');
            }
        });
        
        previewItem.appendChild(removeBtn);
        mediaPreview.appendChild(previewItem);
        mediaPreview.style.display = 'block';
        
        // Enable send button
        sendBtn.removeAttribute('disabled');
    }
});

// Send message handler
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

async function sendMessage() {
    const text = messageInput.value.trim();
    
    // Don't send if no content
    if (!text && !mediaFile) return;
    
    // Show loading state
    const originalBtnContent = sendBtn.innerHTML;
    sendBtn.innerHTML = '<div class="loading-spinner"></div>';
    sendBtn.setAttribute('disabled', 'true');
    
    try {
        let imageURL = null;
        let videoURL = null;
        
// Upload media if present
if (mediaFile) {
const fileRef = storageRef(storage, `imageSharing/${currentUser.uid}/${Date.now()}_${mediaFile.name}`);
await uploadBytes(fileRef, mediaFile);
const url = await getDownloadURL(fileRef);

if (mediaFile.type.startsWith('image/')) {
imageURL = url;
} else if (mediaFile.type.startsWith('video/')) {
videoURL = url;
}
}

// Create message object
const messagesRef = ref(db, 'imageSharing');
await push(messagesRef, {
text,
imageURL,
videoURL,
userId: currentUser.uid,
username: userDetails?.username || currentUser.displayName || 'Anonymous',
photoURL: userDetails?.photoURL || currentUser.photoURL,
timestamp: Date.now()
});

// Reset UI
messageInput.value = '';
messageInput.style.height = 'auto';
mediaPreview.innerHTML = '';
mediaPreview.style.display = 'none';
mediaFile = null;
sendBtn.setAttribute('disabled', 'true');

} catch (error) {
console.error('Error sending message:', error);
alert('Failed to send message. Please try again.');
} finally {
// Reset send button
sendBtn.innerHTML = `
<svg viewBox="0 0 24 24">
  <path d="M2.252 6.456l19.476 5.825c.53.159.53.928 0 1.088L2.252 19.194c-.43.129-.81-.303-.53-.604l4.309-4.672c.45-.487.45-1.256 0-1.742L1.722 7.06c-.28-.302.1-.733.53-.604z"></path>
</svg>
`;
}
}

</script>

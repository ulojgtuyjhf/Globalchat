<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media Feed</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border: 1px solid #dddfe2;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .profile-scroll {
            display: flex;
            overflow-x: auto;
            padding: 10px;
            background-color: #fff;
            border-bottom: 1px solid #dddfe2;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .profile-scroll::-webkit-scrollbar {
            display: none;
        }

        .profile-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 15px;
            cursor: pointer;
        }

        .profile-scroll img {
            border-radius: 50%;
            width: 60px;
            height: 60px;
            object-fit: cover;
            transition: transform 0.3s ease;
            border: 3px solid #6a0dad;
        }

        .profile-name {
            font-size: 12px;
            margin-top: 5px;
            color: #1c1e21;
            max-width: 70px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .post {
            padding: 16px;
            border-bottom: 1px solid #dddfe2;
            transition: all 0.3s ease;
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .post-header img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 10px;
            object-fit: cover;
        }

        .post-header .name {
            font-weight: bold;
            color: #1c1e21;
        }

        .post-header .time {
            color: #606770;
            font-size: 12px;
        }

        .post-content {
            margin-bottom: 12px;
        }

        .post-content .text {
            margin-bottom: 12px;
            color: #1c1e21;
        }

        .post-content .media-container {
            position: relative;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            background-color: #000;
        }

        .post-content video {
            width: 100%;
            max-height: 600px;
            object-fit: contain;
            background-color: #000;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            color: #606770;
            padding: 8px 0;
        }

        .post-actions div {
            cursor: pointer;
            color: #6a0dad;
            font-weight: 600;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 20px;
        }

        .post-actions div:hover {
            background-color: rgba(106, 13, 173, 0.1);
        }

        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            height: 60px;
        }

        .loader {
            display: flex;
            gap: 8px;
        }

        .loader-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #6a0dad;
            animation: wave 1.3s linear infinite;
        }

        .loader-dot:nth-child(2) {
            animation-delay: -1.1s;
        }

        .loader-dot:nth-child(3) {
            animation-delay: -0.9s;
        }

        @keyframes wave {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .error-message {
            text-align: center;
            color: #ff4444;
            padding: 20px;
            display: none;
        }

        .no-posts {
            text-align: center;
            color: #606770;
            padding: 40px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="profile-scroll" id="profileScroll"></div>
        <div id="postsContainer"></div>
        <div class="loader-container" id="loader">
            <div class="loader">
                <div class="loader-dot"></div>
                <div class="loader-dot"></div>
                <div class="loader-dot"></div>
            </div>
        </div>
        <div class="error-message" id="errorMessage">
            Something went wrong. Please try again later.
        </div>
        <div class="no-posts" id="noPosts" style="display: none;">
            No posts available at the moment.
        </div>
    </div>

    <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, getDocs, startAfter, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyDnPz8BWCaXJOazlFVO4Eap8VxdSR2oDFQ",
    authDomain: "globalchat-2d669.firebaseapp.com",
    projectId: "globalchat-2d669",
    storageBucket: "globalchat-2d669.firebasestorage.app",
    messagingSenderId: "178714711978",
    appId: "1:178714711978:web:fb831188be23e62a4bbdd3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

class SocialFeed {
    constructor() {
        this.posts = [];
        this.lastVisible = null;
        this.isLoading = false;
        this.hasMore = true;
        this.batchSize = 5;
        this.activeVideo = null;
        this.profilesLoaded = false;
        this.userCache = new Map();

        this.postsContainer = document.getElementById('postsContainer');
        this.loader = document.getElementById('loader');
        this.errorMessage = document.getElementById('errorMessage');
        this.noPosts = document.getElementById('noPosts');
        this.profileScroll = document.getElementById('profileScroll');

        this.init();
    }

    async init() {
        try {
            await this.checkAuth();
            await this.loadProfiles();
            await this.loadInitialPosts();
            this.setupVideoIntersectionObserver();
            this.setupIntersectionObserver();
            this.setupScrollListener();
        } catch (error) {
            console.error('Initialization error:', error);
            this.showError();
        }
    }

    checkAuth() {
        return new Promise((resolve) => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    resolve(user);
                } else {
                    window.location.href = 'login.html';
                }
            });
        });
    }

    async loadProfiles() {
        if (this.profilesLoaded) return;

        try {
            const usersRef = collection(db, 'users');
            const usersQuery = query(usersRef, limit(10));
            const snapshot = await getDocs(usersQuery);

            const profilesHTML = snapshot.docs.map(doc => {
                const data = doc.data();
                return `
                    <div class="profile-item">
                        <img src="${data.profilePic || 'https://via.placeholder.com/60'}" 
                             alt="${data.username || 'User'}"
                             onerror="this.src='https://via.placeholder.com/60'"/>
                        <div class="profile-name">${data.username || 'User'}</div>
                    </div>
                `;
            }).join('');

            this.profileScroll.innerHTML = profilesHTML;
            this.profilesLoaded = true;
        } catch (error) {
            console.error('Error loading profiles:', error);
            throw error;
        }
    }

    async getUserProfile(userId) {
        if (this.userCache.has(userId)) {
            return this.userCache.get(userId);
        }

        try {
            const userRef = doc(db, 'users', userId);
            const profileRef = doc(db, 'profiles', userId);

            let userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                userSnap = await getDoc(profileRef);
            }

            if (userSnap.exists()) {
                const profile = userSnap.data();
                const userProfile = {
                    username: profile.username || profile.displayName || 'Anonymous User',
                    profilePic: profile.profilePic || profile.photoURL || 'https://via.placeholder.com/150'
                };
                this.userCache.set(userId, userProfile);
                return userProfile;
            }
            
            return {
                username: 'Anonymous User',
                profilePic: 'https://via.placeholder.com/150'
            };
        } catch (error) {
            console.error('Error fetching user profile:', error);
            return {
                username: 'Anonymous User',
                profilePic: 'https://via.placeholder.com/150'
            };
        }
    }

    async loadInitialPosts() {
        this.showLoader();
        try {
            const postsRef = collection(db, 'posts');
            const postsQuery = query(postsRef, orderBy('createdAt', 'desc'), limit(this.batchSize));
            const snapshot = await getDocs(postsQuery);

            if (snapshot.empty) {
                this.showNoPosts();
                return;
            }

            const postsData = await Promise.all(snapshot.docs.map(async (doc) => {
                const postData = doc.data();
                const authorProfile = await this.getUserProfile(postData.userId);
                return {
                    id: doc.id,
                    ...postData,
                    authorProfile
                };
            }));

            this.posts = postsData;
            this.lastVisible = snapshot.docs[snapshot.docs.length - 1];
            this.renderPosts();
        } catch (error) {
            console.error('Error loading posts:', error);
            this.showError();
        } finally {
            this.hideLoader();
        }
    }

    async loadMorePosts() {
        if (this.isLoading || !this.hasMore) return;

        this.isLoading = true;
        this.showLoader();

        try {
            const postsRef = collection(db, 'posts');
            const postsQuery = query(
                postsRef,
                orderBy('createdAt', 'desc'),
                startAfter(this.lastVisible),
                limit(this.batchSize)
            );

            const snapshot = await getDocs(postsQuery);

            if (snapshot.empty) {
                this.hasMore = false;
                return;
            }

            const newPostsData = await Promise.all(snapshot.docs.map(async (doc) => {
                const postData = doc.data();
                const authorProfile = await this.getUserProfile(postData.userId);
                return {
                    id: doc.id,
                    ...postData,
                    authorProfile
                };
            }));

            this.posts = [...this.posts, ...newPostsData];
            this.lastVisible = snapshot.docs[snapshot.docs.length - 1];
            this.renderPosts();
        } catch (error) {
            console.error('Error loading more posts:', error);
            this.showError();
        } finally {
            this.isLoading = false;
            this.hideLoader();
        }
    }

    renderPosts() {
        const postsHTML = this.posts.map(post => this.createPostHTML(post)).join('');
        this.postsContainer.innerHTML = postsHTML;
        this.setupVideoIntersectionObserver();
    }

    createPostHTML(post) {
        const timeAgo = this.getTimeAgo(post.createdAt?.toDate() || new Date());
        return `
            <div class="post" data-post-id="${post.id}">
                <div class="post-header">
                    <img src="${post.authorProfile?.profilePic || 'https://via.placeholder.com/40'}" 
                         alt="${post.authorProfile?.username || 'User'}"
                         onerror="this.src='https://via.placeholder.com/40'"/>
                    <div>
                        <div class="name">${post.authorProfile?.username || 'User'}</div>
                        <div class="time">${timeAgo}</div>
                    </div>
                </div>
                <div class="post-content">
                    <div class="text">${post.text || ''}</div>
                    ${post.mediaUrl ? `
                        <div class="media-container">
                            <video src="${post.mediaUrl}" 
                                   playsinline 
                                   loop 
                                   muted 
                                   preload="metadata"
                                   class="post-video"></video>
                        </div>
                    ` : ''}
                </div>
                <div class="post-actions">
                    <div>Like</div>
                    <div>Comment</div>
                    <div>Share</div>
                </div>
            </div>
        `;
    }

    setupVideoIntersectionObserver() {
        const options = {
            root: null,
            rootMargin: '0px',
            threshold: 0.5
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target;
                if (entry.isIntersecting) {
                    if (this.activeVideo && this.activeVideo !== video) {
                        this.activeVideo.pause();
                    }
                    video.play().catch(err => console.log('Video play error:', err));
                    this.activeVideo = video;
                } else {
                    video.pause();
                    if (this.activeVideo === video) {
                        this.activeVideo = null;
                    }
                }
            });
        }, options);

        document.querySelectorAll('.post-video').forEach(video => {
            observer.observe(video);
        });
    }

    setupIntersectionObserver() {
        const options = {
            root: null,
            rootMargin: '100px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !this.isLoading && this.hasMore) {
                    this.loadMorePosts();
                }
            });
        }, options);

        observer.observe(this.loader);
    }

    setupScrollListener() {
        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            const st = window.pageYOffset || document.documentElement.scrollTop;
            if (st > lastScrollTop) {
                const bottomOfWindow = window.innerHeight + window.pageYOffset;
                const endOfPage = document.documentElement.scrollHeight - 100;
                
                if (bottomOfWindow >= endOfPage && !this.isLoading && this.hasMore) {
                    this.loadMorePosts();
                }
            }
            lastScrollTop = st <= 0 ? 0 : st;
        });
    }

    getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + ' years ago';
        
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + ' months ago';
        
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + ' days ago';
        
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + ' hours ago';
        
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + ' minutes ago';
        
        return 'Just now';
    }

    showLoader() {
        this.loader.style.display = 'flex';
    }

    hideLoader() {
        this.loader.style.display = 'none';
    }

    showError() {
        this.errorMessage.style.display = 'block';
        this.loader.style.display = 'none';
    }

    showNoPosts() {
        this.noPosts.style.display = 'block';
        this.loader.style.display = 'none';
    }
}

// Initialize the social feed
const socialFeed = new SocialFeed();
</script> 

<!DOCTYPE html>
<html>
<head>
    <title>Profile Settings</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <style>
        :root {
            --twitter-bg: #ffffff;
            --twitter-card: #f7f9fa;
            --twitter-line: #ebeef0;
            --twitter-blue: #1da1f2;
            --twitter-light-blue: #1a91da;
            --twitter-text: #14171a;
            --twitter-secondary-text: #657786;
            --twitter-border: #ebeef0;
            --twitter-hover: rgba(29, 161, 242, 0.1);
            --twitter-button: #1da1f2;
            --twitter-button-hover: #1a91da;
            --twitter-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--twitter-bg);
            color: var(--twitter-text);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--twitter-bg);
        }

        .header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            position: sticky;
            top: 0;
            background: var(--twitter-bg);
            z-index: 10;
        }

        .back-button {
            color: var(--twitter-blue);
            font-size: 20px;
            margin-right: 20px;
            cursor: pointer;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
        }

        .settings-list {
            padding: 10px 0;
        }

        .settings-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .settings-item:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .settings-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--twitter-blue);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            color: white;
        }

        .settings-icon i {
            font-size: 15px;
        }

        .settings-item-content {
            flex-grow: 1;
        }

        .settings-item-title {
            font-weight: bold;
            color: var(--twitter-text);
            margin-bottom: 3px;
        }

        .settings-item-subtitle {
            color: var(--twitter-secondary-text);
            font-size: 14px;
        }

        .settings-item-right {
            color: var(--twitter-secondary-text);
            margin-left: 10px;
        }

        .profile-header {
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            background: var(--twitter-bg);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .profile-header.sticky {
            position: sticky;
            top: 0;
            z-index: 5;
            box-shadow: var(--twitter-shadow);
        }

        .profile-info {
            display: flex;
            align-items: center;
        }

        .profile-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--twitter-blue);
            margin-right: 15px;
            cursor: pointer;
        }

        .profile-name-container {
            flex-grow: 1;
        }

        .profile-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--twitter-text);
            margin-bottom: 3px;
        }

        .profile-email {
            color: var(--twitter-secondary-text);
            font-size: 14px;
            display: none;
        }

        .profile-stats {
            display: flex;
            margin-top: 15px;
        }

        .profile-stat {
            margin-right: 20px;
            cursor: pointer;
        }

        .profile-stat-number {
            font-weight: bold;
            color: var(--twitter-text);
        }

        .profile-stat-label {
            color: var(--twitter-secondary-text);
            font-size: 13px;
        }

        /* Edit Profile Page */
        .edit-profile-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--twitter-bg);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .edit-profile-container.active {
            transform: translateX(0);
        }

        .edit-profile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
        }

        .edit-profile-title {
            font-size: 18px;
            font-weight: bold;
        }

        .cancel-button, .save-button {
            background: none;
            border: none;
            color: var(--twitter-blue);
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        .save-button {
            background: var(--twitter-blue);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .save-button:hover {
            background: var(--twitter-light-blue);
        }

        .edit-profile-image-container {
            position: relative;
            width: 100%;
            height: 160px;
            background: var(--twitter-card);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .edit-profile-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--twitter-bg);
        }

        .edit-profile-form {
            padding: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--twitter-secondary-text);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: var(--twitter-card);
            border: 1px solid var(--twitter-line);
            border-radius: 5px;
            color: var(--twitter-text);
            font-size: 16px;
        }

        .form-input:focus {
            border-color: var(--twitter-blue);
            outline: none;
        }

        .form-textarea {
            resize: none;
            height: 100px;
        }

        .character-count {
            text-align: right;
            color: var(--twitter-secondary-text);
            font-size: 14px;
            margin-top: 5px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccd6dd;
            border-radius: 12px;
            cursor: pointer;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle-switch.active {
            background: var(--twitter-blue);
        }

        .toggle-switch.active::before {
            transform: translateX(26px);
        }

        /* Followers Modal */
        .follow-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--twitter-bg);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .follow-screen.active {
            transform: translateX(0);
        }

        .follow-header {
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            display: flex;
            align-items: center;
            background: var(--twitter-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .follow-back {
            margin-right: 20px;
            font-size: 20px;
            color: var(--twitter-blue);
            cursor: pointer;
        }

        .follow-title {
            font-size: 18px;
            font-weight: bold;
        }

        .follow-body {
            flex: 1;
            overflow-y: auto;
        }

        .user-list-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            transition: background 0.2s ease;
        }

        .user-list-item:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .user-list-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 1px solid var(--twitter-line);
        }

        .user-list-item-info {
            flex-grow: 1;
        }

        .user-list-item-name {
            font-weight: bold;
            color: var(--twitter-text);
        }

        .user-list-item-username {
            color: var(--twitter-secondary-text);
            font-size: 14px;
        }

        .follow-button {
            background: var(--twitter-blue);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .follow-button:hover {
            background: var(--twitter-light-blue);
        }

        .following-button {
            background: transparent;
            color: var(--twitter-text);
            border: 1px solid var(--twitter-border);
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .following-button:hover {
            background: rgba(224, 36, 94, 0.1);
            color: #e0245e;
            border-color: rgba(224, 36, 94, 0.2);
        }

        .following-button:hover .follow-text {
            display: none;
        }

        .following-button:hover .unfollow-text {
            display: inline;
        }

        .unfollow-text {
            display: none;
            color: #e0245e;
        }

        .no-results {
            padding: 40px 20px;
            text-align: center;
            color: var(--twitter-secondary-text);
            font-size: 16px;
        }

        .dark-mode {
            --twitter-bg: #15202b;
            --twitter-card: #192734;
            --twitter-line: #38444d;
            --twitter-text: #ffffff;
            --twitter-secondary-text: #8899a6;
            --twitter-border: #38444d;
            --twitter-hover: rgba(29, 161, 242, 0.1);
            --twitter-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--twitter-blue);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Settings Screen -->
        <div class="header">
            <div class="header-title">Settings</div>
        </div>

        <div class="profile-header" id="profileSection">
            <div class="profile-info">
                <img id="profileImage" src="default-profile.png" alt="Profile" class="profile-image">
                <div class="profile-name-container">
                    <div id="profileName" class="profile-name">User Name</div>
                    <div id="profileEmail" class="profile-email">user@example.com</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
            <div class="profile-stats">
                <div class="profile-stat" id="followersBtn">
                    <span id="followersCount" class="profile-stat-number">0</span>
                    <span class="profile-stat-label">Followers</span>
                </div>
                <div class="profile-stat" id="followingBtn">
                    <span id="followingCount" class="profile-stat-number">0</span>
                    <span class="profile-stat-label">Following</span>
                </div>
            </div>
        </div>

        <div class="settings-list">
            <div class="settings-item" id="accountBtn">
                <div class="settings-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="settings-item-content">
                  
                    <div class="settings-item-title">Account</div>
                    <div class="settings-item-subtitle">Security notifications, change number</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="privacyBtn">
                <div class="settings-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Privacy</div>
                    <div class="settings-item-subtitle">Block contacts, disappearing messages</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="chatsBtn">
                <div class="settings-icon">
                    <i class="fas fa-comment"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Chats</div>
                    <div class="settings-item-subtitle">Theme, chat theme</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="notificationsBtn">
                <div class="settings-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Notifications</div>
                    <div class="settings-item-subtitle">Message, group & call tones</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="storageBtn">
                <div class="settings-icon">
                    <i class="fas fa-hdd"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Storage and usage</div>
                    <div class="settings-item-subtitle">manage storage, analytics</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="aboutBtn">
                <div class="settings-icon">
                    <i class="fas fa-language"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">language</div>
                    <div class="settings-item-subtitle">tranlater, original language</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="helpBtn">
                <div class="settings-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Help</div>
                    <div class="settings-item-subtitle">Help center, contact us</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="logoutBtn">
                <div class="settings-icon" style="background: #e0245e;">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Logout</div>
                    <div class="settings-item-subtitle">Log out from your account</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Screen -->
    <div class="edit-profile-container" id="editProfileContainer">
        <div class="edit-profile-header">
            <button class="cancel-button" id="cancelEditProfile">Cancel</button>
            <div class="edit-profile-title">Edit profile</div>
            <button class="save-button" id="saveProfileBtn">Save</button>
        </div>

        <div class="edit-profile-image-container">
            <img id="editProfileImage" src="default-profile.png" alt="Profile" class="edit-profile-image">
            <!-- Camera icon removed as requested -->
            <input type="file" id="profilePictureInput" style="display:none" accept="image/*">
        </div>

        <div class="edit-profile-form">
            <div class="form-group">
                <label class="form-label" for="nameInput">Name</label>
                <input type="text" id="nameInput" class="form-input" placeholder="Add your name">
            </div>

            <div class="form-group">
                <label class="form-label" for="bioInput">Bio</label>
                <textarea id="bioInput" class="form-input form-textarea" placeholder="Add a bio to tell people about yourself" maxlength="150"></textarea>
                <div class="character-count"><span id="bioCharCount">0</span>/150</div>
            </div>

            <div class="form-group">
                <label class="form-label" for="emailDisplay">Email</label>
                <div id="emailDisplay" class="form-input" style="background: var(--twitter-card); opacity: 0.7;"></div>
            </div>
        </div>
    </div>

    <!-- Followers Screen -->
    <div class="follow-screen" id="followersScreen">
        <div class="follow-header">
            <div class="follow-back" id="closeFollowers">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="follow-title" id="followScreenTitle">Followers</div>
        </div>
        <div class="follow-body" id="followersBody">
            <!-- User list will be populated here -->
        </div>
    </div>

    <!-- Following Screen -->
    <div class="follow-screen" id="followingScreen">
        <div class="follow-header">
            <div class="follow-back" id="closeFollowing">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="follow-title">Following</div>
        </div>
        <div class="follow-body" id="followingBody">
            <!-- User list will be populated here -->
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDnPz8BWCaXJOazlFVO4Eap8VxdSR2oDFQ",
    authDomain: "globalchat-2d669.firebaseapp.com",
    projectId: "globalchat-2d669",
    storageBucket: "globalchat-2d669.appspot.com",
    messagingSenderId: "178714711978",
    appId: "1:178714711978:web:fb831188be23e62a4bbdd3"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM Elements - Main Settings
const profileSection = document.getElementById('profileSection');
const profileImage = document.getElementById('profileImage');
const profileName = document.getElementById('profileName');
const profileEmail = document.getElementById('profileEmail');
const followersCount = document.getElementById('followersCount');
const followingCount = document.getElementById('followingCount');
const followersBtn = document.getElementById('followersBtn');
const followingBtn = document.getElementById('followingBtn');
const logoutBtn = document.getElementById('logoutBtn');

// DOM Elements - Edit Profile
const editProfileContainer = document.getElementById('editProfileContainer');
const cancelEditProfile = document.getElementById('cancelEditProfile');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const editProfileImage = document.getElementById('editProfileImage');
const nameInput = document.getElementById('nameInput');
const bioInput = document.getElementById('bioInput');
const bioCharCount = document.getElementById('bioCharCount');
const emailDisplay = document.getElementById('emailDisplay');

// DOM Elements - Followers/Following Screen
const followersScreen = document.getElementById('followersScreen');
const followingScreen = document.getElementById('followingScreen');
const closeFollowers = document.getElementById('closeFollowers');
const closeFollowing = document.getElementById('closeFollowing');
const followersBody = document.getElementById('followersBody');
const followingBody = document.getElementById('followingBody');

// DOM Elements - Toast
const toast = document.getElementById('toast');

// Settings page buttons
const accountBtn = document.getElementById('accountBtn');
const privacyBtn = document.getElementById('privacyBtn');
const chatsBtn = document.getElementById('chatsBtn');
const notificationsBtn = document.getElementById('notificationsBtn');
const storageBtn = document.getElementById('storageBtn');
const aboutBtn = document.getElementById('aboutBtn');
const helpBtn = document.getElementById('helpBtn');

// Function to show toast notifications
function showToast(message, duration = 2000) {
    toast.textContent = message;
    toast.classList.add('active');
    
    setTimeout(() => {
        toast.classList.remove('active');
    }, duration);
}

// Loading Animation
function showLoading() {
    const loadingToast = document.createElement('div');
    loadingToast.id = 'loadingToast';
    loadingToast.className = 'toast active';
    loadingToast.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    document.body.appendChild(loadingToast);
    return loadingToast;
}

function hideLoading(loadingElement) {
    if (loadingElement) {
        loadingElement.remove();
    }
}

// Sticky Profile Header
function initializeStickyHeader() {
    const header = document.querySelector('.header');
    const headerHeight = header.offsetHeight;
    
    window.addEventListener('scroll', () => {
        if (window.scrollY > headerHeight) {
            profileSection.classList.add('sticky');
        } else {
            profileSection.classList.remove('sticky');
        }
    });
}

// Toggle Edit Profile
function initializeEditProfile() {
    profileSection.addEventListener('click', () => {
        editProfileContainer.classList.add('active');
    });

    cancelEditProfile.addEventListener('click', () => {
        editProfileContainer.classList.remove('active');
    });
}

// Bio Input Character Count
function initializeBioCharCount() {
    bioInput.addEventListener('input', () => {
        const count = bioInput.value.length;
        bioCharCount.textContent = count;
    });
}

// Save Profile Changes without image update
async function saveProfileChanges(user) {
    const loadingToast = showLoading();
    const newName = nameInput.value.trim();
    const newBio = bioInput.value.trim();

    try {
        // Save to localStorage
        localStorage.setItem(`displayName_${user.uid}`, newName);
        localStorage.setItem(`bio_${user.uid}`, newBio);
        
        // Update UI immediately
        profileName.textContent = newName;
        
        // Update auth profile without photoURL
        await updateProfile(user, { 
            displayName: newName
        });

        // Update firestore document without photoURL
        await updateDoc(doc(db, 'users', user.uid), {
            displayName: newName,
            bio: newBio
        });

        editProfileContainer.classList.remove('active');
        hideLoading(loadingToast);
        showToast('Profile updated successfully!');
    } catch (error) {
        console.error('Error updating profile:', error);
        hideLoading(loadingToast);
        showToast('Profile updated locally. Some changes may not sync.');
        editProfileContainer.classList.remove('active');
    }
}

// Fetch Follow Data with caching
async function fetchFollowData(user) {
    // Check localStorage first
    const cachedFollowersCount = localStorage.getItem(`followersCount_${user.uid}`);
    const cachedFollowingCount = localStorage.getItem(`followingCount_${user.uid}`);
    
    if (cachedFollowersCount) {
        followersCount.textContent = cachedFollowersCount;
    }
    
    if (cachedFollowingCount) {
        followingCount.textContent = cachedFollowingCount;
    }
    
    try {
        // Fetch followers count
        const followersQuery = query(collection(db, 'follows'), 
            where('followedUserId', '==', user.uid)
        );
        const followersSnapshot = await getDocs(followersQuery);
        followersCount.textContent = followersSnapshot.size;
        localStorage.setItem(`followersCount_${user.uid}`, followersSnapshot.size);

        // Fetch following count
        const followingQuery = query(collection(db, 'follows'), 
            where('followerUserId', '==', user.uid)
        );
        const followingSnapshot = await getDocs(followingQuery);
        followingCount.textContent = followingSnapshot.size;
        localStorage.setItem(`followingCount_${user.uid}`, followingSnapshot.size);
    } catch (error) {
        console.error('Error fetching follow data:', error);
    }
}

// Initialize Followers/Following Screen
function initializeFollowScreens(user) {
    // Followers screen
    followersBtn.addEventListener('click', async () => {
        followersBody.innerHTML = '';
        followersScreen.classList.add('active');
        
        const loadingToast = showLoading();
        
        try {
            const cachedFollowers = localStorage.getItem(`followersList_${user.uid}`);
            
            if (cachedFollowers) {
                followersBody.innerHTML = cachedFollowers;
            } else {
                followersBody.innerHTML = '<div class="no-results">Loading followers...</div>';
            }
            
            const followersQuery = query(collection(db, 'follows'), 
                where('followedUserId', '==', user.uid)
            );
            const followersSnapshot = await getDocs(followersQuery);
            
            if (followersSnapshot.empty) {
                followersBody.innerHTML = '<div class="no-results">No followers yet</div>';
                localStorage.setItem(`followersList_${user.uid}`, followersBody.innerHTML);
            } else {
                let followersHTML = '';
                
                for (const followDoc of followersSnapshot.docs) {
                    const followerData = followDoc.data();
                    const followerUserDoc = await getDoc(doc(db, 'users', followerData.followerUserId));
                    
                    if (followerUserDoc.exists()) {
                        const userData = followerUserDoc.data();
                        followersHTML += `
                            <div class="user-list-item">
                                <img src="${userData.photoURL || 'default-profile.png'}" alt="Profile">
                                <div class="user-list-item-info">
                                    <div class="user-list-item-name">${userData.displayName || 'User'}</div>
                                    <div class="user-list-item-username">@${userData.displayName?.toLowerCase().replace(/\s/g, '') || 'user'}</div>
                                </div>
                                <button class="follow-button">Follow</button>
                            </div>
                        `;
                    }
                }
                
                followersBody.innerHTML = followersHTML;
                localStorage.setItem(`followersList_${user.uid}`, followersHTML);
            }
            
            hideLoading(loadingToast);
        } catch (error) {
            console.error('Error fetching followers:', error);
            followersBody.innerHTML = '<div class="no-results">Error loading followers</div>';
            hideLoading(loadingToast);
        }
    });

    // Following screen
    followingBtn.addEventListener('click', async () => {
        followingBody.innerHTML = '';
        followingScreen.classList.add('active');
        
        const loadingToast = showLoading();
        
        try {
            const cachedFollowing = localStorage.getItem(`followingList_${user.uid}`);
            
            if (cachedFollowing) {
                followingBody.innerHTML = cachedFollowing;
            } else {
                followingBody.innerHTML = '<div class="no-results">Loading following...</div>';
            }
            
            const followingQuery = query(collection(db, 'follows'), 
                where('followerUserId', '==', user.uid)
            );
            const followingSnapshot = await getDocs(followingQuery);
            
            if (followingSnapshot.empty) {
                followingBody.innerHTML = '<div class="no-results">Not following anyone yet</div>';
                localStorage.setItem(`followingList_${user.uid}`, followingBody.innerHTML);
            } else {
                let followingHTML = '';
                
                for (const followDoc of followingSnapshot.docs) {
                    const followingData = followDoc.data();
                    const followedUserDoc = await getDoc(doc(db, 'users', followingData.followedUserId));
                    
                    if (followedUserDoc.exists()) {
                        const userData = followedUserDoc.data();
                        followingHTML += `
                            <div class="user-list-item">
                                <img src="${userData.photoURL || 'default-profile.png'}" alt="Profile">
                                <div class="user-list-item-info">
                                    <div class="user-list-item-name">${userData.displayName || 'User'}</div>
                                    <div class="user-list-item-username">@${userData.displayName?.toLowerCase().replace(/\s/g, '') || 'user'}</div>
                                </div>
                                <button class="following-button">
                                    <span class="follow-text">Following</span>
                                    <span class="unfollow-text">Unfollow</span>
                                </button>
                            </div>
                        `;
                    }
                }
                
                followingBody.innerHTML = followingHTML;
                localStorage.setItem(`followingList_${user.uid}`, followingHTML);
            }
            
            hideLoading(loadingToast);
        } catch (error) {
            console.error('Error fetching following:', error);
            followingBody.innerHTML = '<div class="no-results">Error loading following</div>';
            hideLoading(loadingToast);
        }
    });

    // Close buttons
    closeFollowers.addEventListener('click', () => {
        followersScreen.classList.remove('active');
    });
    
    closeFollowing.addEventListener('click', () => {
        followingScreen.classList.remove('active');
    });
}

// Initialize Settings Buttons
function initializeSettingsButtons() {
    const settingsPageMap = {
        'accountBtn': 'account.html',
        'privacyBtn': 'privacy.html',
        'chatsBtn': 'chats.html',
        'notificationsBtn': 'notifications.html',
        'storageBtn': 'storage.html',
        'aboutBtn': 'about.html',
        'helpBtn': 'help.html'
    };
    
    for (const [buttonId, pagePath] of Object.entries(settingsPageMap)) {
        const button = document.getElementById(buttonId);
        
        if (button) {
            button.addEventListener('click', () => {
                const loadingToast = showLoading();
                setTimeout(() => {
                    hideLoading(loadingToast);
                    const title = button.querySelector('.settings-item-title').textContent;
                    showToast(`${title} settings would load ${pagePath}`);
                }, 500);
            });
        }
    }
}

// Logout - FIXED VERSION
function initializeLogout() {
    if (logoutBtn) {
        // Remove any existing event listeners
        logoutBtn.replaceWith(logoutBtn.cloneNode(true));
        
        // Get the fresh reference
        const freshLogoutBtn = document.getElementById('logoutBtn');
        
        // Add the correct event listener
        freshLogoutBtn.addEventListener('click', async () => {
            const loadingToast = showLoading();
            
            try {
                await signOut(auth);
                hideLoading(loadingToast);
                // Redirect to index.html instead of login.html
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
                hideLoading(loadingToast);
                showToast('Failed to log out. Please try again.');
            }
        });
    }
}

// Page Animation
function initializePageAnimation() {
    document.body.style.opacity = '0';
    setTimeout(() => {
        document.body.style.transition = 'opacity 0.3s ease';
        document.body.style.opacity = '1';
    }, 100);
}

// Load user data from local storage first, then update from Firestore
async function loadUserData(user) {
    const cachedName = localStorage.getItem(`displayName_${user.uid}`);
    const cachedBio = localStorage.getItem(`bio_${user.uid}`);
    
    if (cachedName) {
        profileName.textContent = cachedName;
        nameInput.value = cachedName;
    } else {
        profileName.textContent = user.displayName || 'User';
        nameInput.value = user.displayName || '';
    }
    
    if (cachedBio) {
        bioInput.value = cachedBio;
        bioCharCount.textContent = cachedBio.length;
    }
    
    // Set default profile images
    profileImage.src = 'default-profile.png';
    editProfileImage.src = 'default-profile.png';
    
    emailDisplay.textContent = user.email || '';
    
    try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        
        if (userDoc.exists()) {
            const userData = userDoc.data();
            localStorage.setItem(`displayName_${user.uid}`, userData.displayName || user.displayName || 'User');
            localStorage.setItem(`bio_${user.uid}`, userData.bio || '');
            
            profileName.textContent = userData.displayName || user.displayName || 'User';
            nameInput.value = userData.displayName || user.displayName || '';
            bioInput.value = userData.bio || '';
            bioCharCount.textContent = (userData.bio || '').length;
        } else {
            const userData = {
                displayName: user.displayName || cachedName || 'User',
                email: user.email,
                photoURL: null,
                bio: cachedBio || '',
                createdAt: new Date()
            };
            
            await updateDoc(doc(db, 'users', user.uid), userData);
        }
    } catch (error) {
        console.error('Error fetching user data from Firestore:', error);
    }
}

// Authentication State Observer
onAuthStateChanged(auth, async (user) => {
    if (user) {
        const loadingToast = showLoading();
        
        try {
            await loadUserData(user);
            initializeStickyHeader();
            initializeEditProfile();
            initializeBioCharCount();
            initializeFollowScreens(user);
            initializeSettingsButtons();
            initializeLogout(); // This is the fixed logout function
            fetchFollowData(user);
            initializePageAnimation();
            saveProfileBtn.addEventListener('click', () => saveProfileChanges(user));
            
            hideLoading(loadingToast);
        } catch (error) {
            console.error('Error initializing app:', error);
            hideLoading(loadingToast);
            showToast('An error occurred while loading your profile');
        }
    } else {
        window.location.href = 'index.html';
    }
});

// Handle follow/unfollow actions
document.addEventListener('click', async (e) => {
    const user = auth.currentUser;
    if (!user) return;

    if (e.target.classList.contains('follow-button')) {
        const loadingToast = showLoading();
        const userItem = e.target.closest('.user-list-item');
        const username = userItem.querySelector('.user-list-item-username').textContent.substring(1);
        
        try {
            e.target.textContent = 'Following';
            e.target.classList.remove('follow-button');
            e.target.classList.add('following-button');
            
            const currentCount = parseInt(followingCount.textContent);
            followingCount.textContent = currentCount + 1;
            localStorage.setItem(`followingCount_${user.uid}`, currentCount + 1);
            
            hideLoading(loadingToast);
            showToast(`You are now following ${username}`);
        } catch (error) {
            console.error('Error following user:', error);
            hideLoading(loadingToast);
            showToast('Failed to follow user. Please try again.');
        }
    }
    
    if (e.target.classList.contains('following-button') || 
        e.target.parentElement.classList.contains('following-button')) {
        
        const loadingToast = showLoading();
        const userItem = e.target.closest('.user-list-item');
        const username = userItem.querySelector('.user-list-item-username').textContent.substring(1);
        
        try {
            const button = e.target.classList.contains('following-button') ? 
                e.target : e.target.parentElement;
            
            button.innerHTML = 'Follow';
            button.classList.remove('following-button');
            button.classList.add('follow-button');
            
            const currentCount = parseInt(followingCount.textContent);
            if (currentCount > 0) {
                followingCount.textContent = currentCount - 1;
                localStorage.setItem(`followingCount_${user.uid}`, currentCount - 1);
            }
            
            hideLoading(loadingToast);
            showToast(`You have unfollowed ${username}`);
        } catch (error) {
            console.error('Error unfollowing user:', error);
            hideLoading(loadingToast);
            showToast('Failed to unfollow user. Please try again.');
        }
    }
});

// Remove any conflicting event listeners added by other scripts
document.addEventListener('DOMContentLoaded', function() {
    // Make sure the logout button is properly configured
    setTimeout(() => {
        initializeLogout();
    }, 500);
});

</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const settingsMap = {
      'accountBtn': 'account.html',
      'privacyBtn': 'privacy.html',
      'chatsBtn': 'chats.html',
      'notificationsBtn': 'notifications.html',
      'storageBtn': 'localst.html',
      'aboutBtn': 'translate.html',
      'helpBtn': 'help.html'
    };
    
    const iframeContainers = {};
    
    const createIframeContainer = function(title, contentFile) {
      const iframeContainer = document.createElement('div');
      iframeContainer.className = 'settingsIframeContainer';
      iframeContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--twitter-bg);
        z-index: 2000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
      `;
      
      const frameHeader = document.createElement('div');
      frameHeader.style.cssText = `
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid var(--twitter-line);
        background: var(--twitter-bg);
        position: sticky;
        top: 0;
        z-index: 10;
      `;
      
      frameHeader.innerHTML = `
        <div class="backBtn" style="margin-right: 20px; cursor: pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 11H7.83L13.42 5.41L12 4L4 12L12 20L13.41 18.59L7.83 13H20V11Z" fill="#1da1f2"/>
            </svg>
        </div>
        <div style="font-size: 18px; font-weight: bold;">${title}</div>
      `;
      
      const iframe = document.createElement('iframe');
      iframe.src = contentFile;
      iframe.style.cssText = `
        flex: 1;
        width: 100%;
        border: none;
        overflow-y: auto;
      `;
      
      iframe.onload = function() {
        if (!iframe.contentWindow || iframe.contentWindow.location.href === 'about:blank') {
          console.error(`Failed to load ${contentFile}. Retrying...`);
          iframe.src = contentFile;
        }
      };
      
      iframe.onerror = function() {
        console.error(`Error loading ${contentFile}`);
      };
      
      iframeContainer.appendChild(frameHeader);
      iframeContainer.appendChild(iframe);
      document.body.appendChild(iframeContainer);
      
      return iframeContainer;
    };
    
    for (const [btnId, contentFile] of Object.entries(settingsMap)) {
      const btn = document.getElementById(btnId);
      if (!btn) continue;
      
      const title = btn.querySelector('.settings-item-title')?.textContent || 'Settings';
      iframeContainers[btnId] = createIframeContainer(title, contentFile);
      
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        for (const container of Object.values(iframeContainers)) {
          container.style.transform = 'translateX(100%)';
        }
        
        const container = iframeContainers[btnId];
        const iframe = container.querySelector('iframe');
        
        if (iframe.src !== contentFile) {
          iframe.src = contentFile;
        }
        
        container.style.transform = 'translateX(0)';
        document.body.style.overflow = 'hidden';
        
        document.querySelectorAll('.toast').forEach(toast => {
          toast.style.display = 'none';
        });
        
        return false;
      });
      
      iframeContainers[btnId].querySelector('.backBtn').addEventListener('click', function() {
        iframeContainers[btnId].style.transform = 'translateX(100%)';
        setTimeout(() => {
          document.body.style.overflow = '';
        }, 300);
      });
    }
    
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        document.querySelectorAll('.toast').forEach(toast => {
          toast.style.display = 'none';
        });
        
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 500);
        
        return false;
      });
    }
    
    const originalShowToast = window.showToast;
    window.showToast = function() {};
    
    document.querySelectorAll('[id*="loading"]').forEach(element => {
      element.style.display = 'none';
    });
    
    function applyThemeToIframes(theme) {
      let bgColor, textColor, lineColor, accentColor;
      
      switch (theme) {
        case 'dim':
          bgColor = '#15202b';
          textColor = '#ffffff';
          lineColor = '#38444d';
          accentColor = '#1da1f2';
          break;
        case 'dark':
          bgColor = '#000000';
          textColor = '#ffffff';
          lineColor = '#2f3336';
          accentColor = '#1da1f2';
          break;
        default:
          bgColor = '#ffffff';
          textColor = '#0f1419';
          lineColor = '#eff3f4';
          accentColor = '#1da1f2';
      }
      
      for (const container of Object.values(iframeContainers)) {
        container.style.background = bgColor;
        
        const header = container.querySelector('div:first-child');
        if (header) {
          header.style.background = bgColor;
          header.style.borderBottom = `1px solid ${lineColor}`;
          header.style.color = textColor;
          
          const backBtn = header.querySelector('.backBtn svg path');
          if (backBtn) {
            backBtn.setAttribute('fill', accentColor);
          }
        }
        
        try {
          const iframe = container.querySelector('iframe');
          if (iframe && iframe.contentDocument) {
            const style = iframe.contentDocument.createElement('style');
            style.textContent = `
              :root {
                --twitter-bg: ${bgColor} !important;
                --twitter-text: ${textColor} !important;
                --twitter-line: ${lineColor} !important;
                --twitter-accent: ${accentColor} !important;
              }
              body {
                background-color: ${bgColor} !important;
                color: ${textColor} !important;
              }
              .settings-section {
                background-color: ${bgColor} !important;
                border-color: ${lineColor} !important;
              }
            `;
            
            const existingStyle = iframe.contentDocument.querySelector('style[data-theme-injected]');
            if (existingStyle) {
              existingStyle.textContent = style.textContent;
            } else {
              style.setAttribute('data-theme-injected', 'true');
              iframe.contentDocument.head.appendChild(style);
            }
          }
        } catch (e) {
          console.log('Could not access iframe content for theme application');
        }
      }
    }
    
    window.addEventListener('storage', function(e) {
      if (e.key === 'twitter-theme') {
        applyThemeToIframes(e.newValue);
      }
    });
    
    let lastKnownTheme = localStorage.getItem('twitter-theme') || 'light';
    applyThemeToIframes(lastKnownTheme);
    
    setInterval(() => {
      const currentTheme = localStorage.getItem('twitter-theme');
      if (currentTheme && currentTheme !== lastKnownTheme) {
        lastKnownTheme = currentTheme;
        applyThemeToIframes(currentTheme);
      }
    }, 1000);
  });
</script>
<script>
(function() {
  // Define a unique color for each letter Aâ€“Z
  const letterColors = {
    A: "#1abc9c", B: "#2ecc71", C: "#3498db", D: "#9b59b6", E: "#34495e",
    F: "#16a085", G: "#27ae60", H: "#2980b9", I: "#8e44ad", J: "#2c3e50",
    K: "#f1c40f", L: "#e67e22", M: "#e74c3c", N: "#ecf0f1", O: "#95a5a6",
    P: "#f39c12", Q: "#d35400", R: "#c0392b", S: "#bdc3c7", T: "#7f8c8d",
    U: "#ff5733", V: "#33ff57", W: "#3357ff", X: "#ff33a6", Y: "#a633ff", Z: "#33fff5"
  };

  // Generate an avatar image using a canvas
  function generateLetterAvatar(username) {
    const trimmed = username.trim();
    const letter = trimmed.charAt(0).toUpperCase();
    const color = letterColors[letter] || "#000000";
    
    const canvas = document.createElement('canvas');
    canvas.width = 100;
    canvas.height = 100;
    const context = canvas.getContext('2d');

    // Draw background
    context.fillStyle = color;
    context.fillRect(0, 0, canvas.width, canvas.height);

    // Draw the letter in white
    context.fillStyle = "#FFFFFF";
    context.font = "bold 50px Arial";
    context.textAlign = "center";
    context.textBaseline = "middle";
    context.fillText(letter, canvas.width / 2, canvas.height / 2);

    return canvas.toDataURL("image/png");
  }

  // Apply the avatar to a specific image element if it's using the default image
  function applyAvatarIfNeeded(imageElement, username) {
    if (imageElement) {
      const currentSrc = imageElement.src;
      const isDefaultImage = currentSrc.includes('default-profile.png') || currentSrc === '';

      if (isDefaultImage) {
        // Only apply the avatar if the image is default
        const avatarDataUrl = generateLetterAvatar(username);
        imageElement.src = avatarDataUrl;
      }
    }
  }

  // Observe changes to an image element and reapply the avatar if necessary
  function observeImageChanges(imageElement, username) {
    if (imageElement) {
      const observer = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
            // Reapply the avatar only if the new src is the default image
            applyAvatarIfNeeded(imageElement, username);
          }
        }
      });

      // Start observing the image for attribute changes
      observer.observe(imageElement, { attributes: true });
    }
  }

  // Apply avatars to all user profile images in the Followers and Following lists
  function applyAvatarsToUserLists() {
    const userListItems = document.querySelectorAll('.user-list-item');

    userListItems.forEach((userItem) => {
      const profileImageEl = userItem.querySelector('img');
      const usernameEl = userItem.querySelector('.user-list-item-name');

      if (profileImageEl && usernameEl) {
        const username = usernameEl.textContent || '';
        applyAvatarIfNeeded(profileImageEl, username);
        observeImageChanges(profileImageEl, username);
      }
    });
  }

  // Initialize the avatar script for all relevant images
  function initializeAvatarScript() {
    const profileNameEl = document.getElementById('profileName');
    const profileImageEl = document.getElementById('profileImage');
    const editProfileImageEl = document.getElementById('editProfileImage');

    if (profileNameEl) {
      const username = profileNameEl.textContent || '';

      // Apply avatar to the main profile image
      if (profileImageEl) {
        applyAvatarIfNeeded(profileImageEl, username);
        observeImageChanges(profileImageEl, username);
      }

      // Apply avatar to the edit profile image
      if (editProfileImageEl) {
        applyAvatarIfNeeded(editProfileImageEl, username);
        observeImageChanges(editProfileImageEl, username);
      }
    }

    // Apply avatars to users in the Followers and Following lists
    applyAvatarsToUserLists();

    // Observe dynamic changes to the Followers and Following lists
    const followersBody = document.getElementById('followersBody');
    const followingBody = document.getElementById('followingBody');

    if (followersBody) {
      const followersObserver = new MutationObserver(applyAvatarsToUserLists);
      followersObserver.observe(followersBody, { childList: true, subtree: true });
    }

    if (followingBody) {
      const followingObserver = new MutationObserver(applyAvatarsToUserLists);
      followingObserver.observe(followingBody, { childList: true, subtree: true });
    }
  }

  // Run the script after the DOM is fully loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAvatarScript);
  } else {
    initializeAvatarScript();
  }
})();
</script>


<script>
  (function() {
    // Force theme application with higher specificity and !important flags
    const applyThemeWithForce = function(themeName) {
      // Define themes with more specific values
      const themes = {
        light: {
          bg: '#ffffff',
          card: '#f7f9fa',
          line: '#ebeef0',
          text: '#14171a',
          secondaryText: '#657786',
          border: '#ebeef0',
          blue: '#1da1f2',
          lightBlue: '#1a91da',
          button: '#1da1f2',
          buttonHover: '#1a91da',
          hover: 'rgba(29, 161, 242, 0.1)',
          shadow: '0 0 10px rgba(0, 0, 0, 0.1)'
        },
        dim: {
          bg: '#15202b',
          card: '#192734',
          line: '#38444d',
          text: '#ffffff',
          secondaryText: '#8899a6',
          border: '#38444d',
          blue: '#1da1f2',
          lightBlue: '#1a91da',
          button: '#1da1f2',
          buttonHover: '#1a91da',
          hover: 'rgba(29, 161, 242, 0.1)',
          shadow: '0 0 10px rgba(0, 0, 0, 0.4)'
        },
        dark: {
          bg: '#000000',
          card: '#16181c',
          line: '#2f3336',
          text: '#ffffff',
          secondaryText: '#8899a6',
          border: '#2f3336',
          blue: '#1da1f2',
          lightBlue: '#1a91da',
          button: '#1da1f2',
          buttonHover: '#1a91da',
          hover: 'rgba(29, 161, 242, 0.1)',
          shadow: '0 0 10px rgba(0, 0, 0, 0.4)'
        }
      };
      
      // Default to light theme if invalid theme name
      const theme = themes[themeName] || themes.light;
      
      // Apply theme through CSS variables with !important
      const rootStyle = document.documentElement.style;
      rootStyle.setProperty('--twitter-bg', theme.bg, 'important');
      rootStyle.setProperty('--twitter-card', theme.card, 'important');
      rootStyle.setProperty('--twitter-line', theme.line, 'important');
      rootStyle.setProperty('--twitter-text', theme.text, 'important');
      rootStyle.setProperty('--twitter-secondary-text', theme.secondaryText, 'important');
      rootStyle.setProperty('--twitter-border', theme.border, 'important');
      rootStyle.setProperty('--twitter-blue', theme.blue, 'important');
      rootStyle.setProperty('--twitter-light-blue', theme.lightBlue, 'important');
      rootStyle.setProperty('--twitter-button', theme.button, 'important');
      rootStyle.setProperty('--twitter-button-hover', theme.buttonHover, 'important');
      rootStyle.setProperty('--twitter-hover', theme.hover, 'important');
      rootStyle.setProperty('--twitter-shadow', theme.shadow, 'important');
      
      // Apply direct styles to body for higher specificity
      document.body.style.setProperty('background-color', theme.bg, 'important');
      document.body.style.setProperty('color', theme.text, 'important');
      
      // Apply classes for compatibility with existing CSS
      document.body.classList.remove('dark-mode');
      if (themeName === 'dark' || themeName === 'dim') {
        document.body.classList.add('dark-mode');
      }
      
      // Force-apply styles to common elements that might resist theme changes
      const forceElements = function() {
        // Apply to container elements
        document.querySelectorAll('.container, .header, .profile-header, .settings-list, .settings-item, .edit-profile-container, .follow-screen').forEach(el => {
          el.style.setProperty('background-color', theme.bg, 'important');
          el.style.setProperty('color', theme.text, 'important');
          el.style.setProperty('border-color', theme.line, 'important');
        });
        
        // Apply to specific text elements
        document.querySelectorAll('.profile-name, .settings-item-title, .edit-profile-title, .follow-title').forEach(el => {
          el.style.setProperty('color', theme.text, 'important');
        });
        
        // Apply to secondary text elements
        document.querySelectorAll('.profile-email, .settings-item-subtitle, .profile-stat-label').forEach(el => {
          el.style.setProperty('color', theme.secondaryText, 'important');
        });
        
        // Apply to borders and lines
        document.querySelectorAll('*[class*="-border"], *[class*="-line"]').forEach(el => {
          el.style.setProperty('border-color', theme.line, 'important');
        });
      };
      
      // Apply forced styles immediately
      forceElements();
      
      // Also apply after a short delay to override any late-loading styles
      setTimeout(forceElements, 100);
      setTimeout(forceElements, 500);
      setTimeout(forceElements, 1000);
      
      // Save to localStorage
      localStorage.setItem('twitter-theme', themeName);
      
      // Log theme application for debugging
      console.log('Theme applied:', themeName);
    };
    
    // Function to detect and apply the initial theme
    const initTheme = function() {
      const savedTheme = localStorage.getItem('twitter-theme');
      if (savedTheme) {
        applyThemeWithForce(savedTheme);
      } else {
        // Default to light theme
        applyThemeWithForce('light');
      }
    };
    
    // Listen for localStorage changes
    window.addEventListener('storage', function(e) {
      if (e.key === 'twitter-theme') {
        applyThemeWithForce(e.newValue);
        console.log('Theme changed via storage event:', e.newValue);
      }
    });
    
    // Create a robust polling mechanism to ensure theme consistency
    let lastKnownTheme = localStorage.getItem('twitter-theme') || 'light';
    
    const robustThemeCheck = function() {
      const currentTheme = localStorage.getItem('twitter-theme');
      
      // Apply theme if different than last known
      if (currentTheme && currentTheme !== lastKnownTheme) {
        console.log('Theme changed via polling:', currentTheme, 'from', lastKnownTheme);
        lastKnownTheme = currentTheme;
        applyThemeWithForce(currentTheme);
      }
      
      // Also periodically reapply current theme to override any competing styles
      else if (currentTheme) {
        // Check if theme is actually applied by testing a key property
        const actualBg = getComputedStyle(document.documentElement).getPropertyValue('--twitter-bg').trim();
        const targetBg = (currentTheme === 'dark') ? '#000000' :
          (currentTheme === 'dim') ? '#15202b' : '#ffffff';
        
        if (actualBg !== targetBg) {
          console.log('Theme enforcement needed. Expected:', targetBg, 'Actual:', actualBg);
          applyThemeWithForce(currentTheme);
        }
      }
    };
    
    // Poll frequently at the beginning, then less frequently
    const pollIntervals = [100, 200, 500, 1000, 2000, 5000];
    pollIntervals.forEach(interval => {
      setTimeout(robustThemeCheck, interval);
    });
    
    // Continue with a reasonable interval
    setInterval(robustThemeCheck, 2000);
    
    // Add manual theme control for testing
    window._forceTheme = function(theme) {
      applyThemeWithForce(theme);
      return `Theme ${theme} has been forcefully applied`;
    };
    
    // Detect and fix issues with dark theme specifically
    const enforceDarkTheme = function() {
      const currentTheme = localStorage.getItem('twitter-theme');
      if (currentTheme === 'dark') {
        // Super aggressive dark theme application
        document.body.style.setProperty('background-color', '#000000', 'important');
        document.documentElement.style.setProperty('--twitter-bg', '#000000', 'important');
        
        // Extra specificity by adding an inline style sheet
        const styleEl = document.createElement('style');
        styleEl.innerHTML = `
        :root { --twitter-bg: #000000 !important; }
        body { background-color: #000000 !important; }
        .container, .header, .profile-header, .settings-list, .settings-item { 
          background-color: #000000 !important; 
        }
      `;
        document.head.appendChild(styleEl);
      }
    };
    
    // Apply dark theme fixes periodically
    setInterval(enforceDarkTheme, 1000);
    
    // Initialize theme when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTheme);
    } else {
      initTheme();
    }
    
    // Also initialize on load to be extra safe
    window.addEventListener('load', initTheme);
  })();
</script>


<script>
  (function() {
  // Apply color palette on load
  applyProfileColorPalette();
  
  // Listen for changes in localStorage
  window.addEventListener('storage', function(event) {
    if (event.key === 'color-value' || event.key === 'color-palette') {
      applyProfileColorPalette();
    }
  });
  
  // Listen for custom events
  window.addEventListener('chatColorChanged', function(event) {
    applyProfileColorPalette();
  });
  
  function applyProfileColorPalette() {
    const savedColorValue = localStorage.getItem('color-value');
    const savedColorIndex = localStorage.getItem('color-palette');
    
    // Only apply if we have a valid color and it's not the default blue
    if (savedColorValue && savedColorIndex !== '0') {
      // Convert hex to RGB
      const colorObj = hexToRGB(savedColorValue);
      const rgbString = `${colorObj.r}, ${colorObj.g}, ${colorObj.b}`;
      
      // Create style element for all overrides
      let styleEl = document.getElementById('profile-color-palette-style');
      if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'profile-color-palette-style';
        document.head.appendChild(styleEl);
      }
      
      // Apply to all blue elements while preserving the logout button color
      styleEl.textContent = `
        /* Twitter variables */
        :root {
          --twitter-blue: ${savedColorValue} !important;
          --twitter-light-blue: ${darkenColor(savedColorValue, 0.15)} !important;
          --twitter-hover: rgba(${rgbString}, 0.1) !important;
          --twitter-button: ${savedColorValue} !important;
          --twitter-button-hover: ${darkenColor(savedColorValue, 0.15)} !important;
        }
        
        /* Keep logout button red */
        #logoutBtn .settings-icon {
          background: #e0245e !important;
        }
        
        /* Back button */
        .back-button, .follow-back, .backBtn svg path {
          color: ${savedColorValue} !important;
          fill: ${savedColorValue} !important;
        }
        
        /* Regular settings icons */
        .settings-icon:not(#logoutBtn .settings-icon) {
          background: ${savedColorValue} !important;
        }
        
        /* Profile elements */
        .profile-image {
          border-color: ${savedColorValue} !important;
        }
        
        /* Buttons */
        .cancel-button {
          color: ${savedColorValue} !important;
        }
        
        .save-button {
          background: ${savedColorValue} !important;
          color: white !important;
        }
        
        .save-button:hover {
          background: ${darkenColor(savedColorValue, 0.15)} !important;
        }
        
        /* Form elements */
        .form-input:focus {
          border-color: ${savedColorValue} !important;
          outline-color: ${savedColorValue} !important;
        }
        
        /* Follow buttons */
        .follow-button {
          background: ${savedColorValue} !important;
        }
        
        .follow-button:hover {
          background: ${darkenColor(savedColorValue, 0.15)} !important;
        }
        
        /* Toggle switches */
        .toggle-switch.active {
          background: ${savedColorValue} !important;
        }
      `;
    } else {
      // Remove all custom styles to revert to default
      const styleEl = document.getElementById('profile-color-palette-style');
      if (styleEl) {
        styleEl.remove();
      }
    }
  }
  
  function hexToRGB(hex) {
    hex = hex.replace('#', '');
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    return { r, g, b };
  }
  
  function darkenColor(hex, percent) {
    hex = hex.replace('#', '');
    let r = parseInt(hex.substring(0, 2), 16);
    let g = parseInt(hex.substring(2, 4), 16);
    let b = parseInt(hex.substring(4, 6), 16);
    
    r = Math.floor(r * (1 - percent));
    g = Math.floor(g * (1 - percent));
    b = Math.floor(b * (1 - percent));
    
    r = Math.max(0, r);
    g = Math.max(0, g);
    b = Math.max(0, b);
    
    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
  }
})();
</script>

<script>

(function() {
  // Language Sync Manager - Optimized version
  const LanguageSyncManager = {
    originalLanguage: document.documentElement.lang || 'en',
    currentLanguage: null,
    isTranslating: false,
    translationTimeout: null,
    
    initialize: function() {
      // Create necessary elements
      this.createLoadingIndicator();
      this.createGoogleTranslateElement();
      
      // Check saved language preference
      const savedLanguage = localStorage.getItem('preferredLanguage');
      if (savedLanguage && savedLanguage !== this.originalLanguage) {
        this.currentLanguage = savedLanguage;
        this.showLoading();
        // Short delay to ensure DOM is ready
        setTimeout(() => this.loadGoogleTranslateScript(), 100);
      }
      
      // Setup event listeners
      this.setupEventListeners();
      
      // Add additional hiding mechanism
      this.setupTranslateElementHider();
      console.log('Language Sync Manager initialized');
    },
    
    createLoadingIndicator: function() {
      const loadingOverlay = document.createElement('div');
      loadingOverlay.className = 'language-loading-overlay';
      loadingOverlay.innerHTML = `
        <div class="language-loading-spinner">
          <div class="language-loading-dot"></div>
          <div class="language-loading-dot"></div>
          <div class="language-loading-dot"></div>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
      
      // Add the styles with improved hiding selectors
      const style = document.createElement('style');
      style.textContent = `
        .language-loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(255, 255, 255, 0.7);
          z-index: 9999;
          display: flex;
          justify-content: center;
          align-items: center;
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.2s ease;
        }
        
        .language-loading-overlay.active {
          opacity: 1;
          visibility: visible;
        }
        
        .language-loading-spinner {
          display: flex;
          gap: 5px;
        }
        
        .language-loading-dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background-color: #4a90e2;
          animation: language-loading-bounce 1.4s infinite ease-in-out both;
        }
        
        .language-loading-dot:nth-child(1) {
          animation-delay: -0.32s;
        }
        
        .language-loading-dot:nth-child(2) {
          animation-delay: -0.16s;
        }
        
        @keyframes language-loading-bounce {
          0%, 80%, 100% {
            transform: scale(0);
          }
          40% {
            transform: scale(1);
          }
        }
        
        /* Comprehensive Google element hiding */
        .goog-te-banner-frame,
        .goog-te-balloon-frame,
        #goog-gt-tt,
        .goog-tooltip,
        .goog-tooltip:hover,
        .goog-text-highlight,
        .VIpgJd-ZVi9od-l4eHX-hSRGPd,
        .VIpgJd-ZVi9od-ORHb-OEVmcd,
        .VIpgJd-ZVi9od-SmfZ-OEVmcd-tJHJj,
        .goog-te-gadget,
        .goog-logo-link,
        .goog-te-combo,
        .skiptranslate,
        .goog-te-banner-frame,
        iframe[name="googleTranslateElementInitialIframe"],
        iframe.goog-te-menu-frame,
        iframe.VIpgJd-ZVi9od-SmfZ-OEVmcd-tJHJj,
        .VIpgJd-yAWNEb-L7lbkb,
        #goog-gt-,
        .goog-te-menu-value,
        div#goog-gt-,
        #goog-gt-tt.skiptranslate,
        .goog-te-spinner-pos,
        .goog-te-spinner,
        .goog-te-banner-frame.skiptranslate,
        .goog-te-sectional-gadget {
          display: none !important;
          visibility: hidden !important;
          opacity: 0 !important;
          height: 0 !important;
          width: 0 !important;
          border: none !important;
          position: absolute !important;
          top: -9999px !important;
          left: -9999px !important;
          pointer-events: none !important;
          max-height: 0 !important;
          max-width: 0 !important;
          transform: scale(0) !important;
        }
        
        body {
          top: 0 !important;
          position: static !important;
        }
        
        /* Additional fixes to prevent any translation UI */
        .VIpgJd-ZVi9od-aZ2wEe-wOHMyf,
        .VIpgJd-ZVi9od-aZ2wEe-OiiCO,
        .VIpgJd-ZVi9od-aZ2wEe {
          display: none !important;
          height: 0 !important;
        }
        
        /* Fix for top bar spacing issue */
        html[translated], 
        body[translated] {
          margin-top: 0 !important;
          padding-top: 0 !important;
        }
      `;
      
      document.head.appendChild(style);
    },
    
    createGoogleTranslateElement: function() {
      // Create hidden Google Translate element
      const translateElement = document.createElement('div');
      translateElement.id = 'google_translate_element';
      translateElement.style.cssText = 'position:absolute;top:-9999px;left:-9999px;width:0;height:0;visibility:hidden;opacity:0;pointer-events:none;overflow:hidden;';
      document.body.appendChild(translateElement);
    },
    
    setupTranslateElementHider: function() {
      // Continuous hiding of Google elements
      const hideGoogleElements = () => {
        // List of selectors that Google Translate might create
        const selectors = [
          '.goog-te-banner-frame',
          '.goog-te-menu-frame',
          '.goog-tooltip',
          '.skiptranslate',
          'iframe.goog-te-menu-frame',
          '#goog-gt-tt',
          '.VIpgJd-ZVi9od-l4eHX-hSRGPd',
          '.VIpgJd-ZVi9od-ORHb-OEVmcd',
          '.VIpgJd-ZVi9od-SmfZ-OEVmcd-tJHJj'
        ];
        
        selectors.forEach(selector => {
          const elements = document.querySelectorAll(selector);
          elements.forEach(el => {
            if (el && el.style) {
              el.style.display = 'none';
              el.style.visibility = 'hidden';
              el.style.opacity = '0';
              el.style.height = '0';
              el.style.width = '0';
              el.style.border = 'none';
              el.style.position = 'absolute';
              el.style.top = '-9999px';
              el.style.left = '-9999px';
              el.style.pointerEvents = 'none';
            }
          });
        });
        
        // Fix body positioning if Google modified it
        if (document.body.style.top && document.body.style.top !== '0px') {
          document.body.style.top = '0px';
          document.body.style.position = 'static';
        }
      };
      
      // Run immediately
      hideGoogleElements();
      
      // Then set up interval to keep hiding them
      setInterval(hideGoogleElements, 500);
      
      // Also hide on DOM changes
      const observer = new MutationObserver(hideGoogleElements);
      observer.observe(document.body, { 
        childList: true, 
        subtree: true 
      });
    },
    
    loadGoogleTranslateScript: function() {
      // If already loaded, apply translation directly
      if (window.google && window.google.translate) {
        this.applyTranslation();
        return;
      }
      
      // Define callback for Google Translate
      window.googleTranslateElementInit = () => {
        new google.translate.TranslateElement({
          pageLanguage: this.originalLanguage,
          autoDisplay: false,
          includedLanguages: '', // Load all languages for flexibility
          layout: google.translate.TranslateElement.InlineLayout.SIMPLE
        }, 'google_translate_element');
        
        // Apply translation immediately after init
        setTimeout(() => this.applyTranslation(), 300);
      };
      
      // Load Google Translate script
      const script = document.createElement('script');
      script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
      script.async = true;
      document.head.appendChild(script);
      
      // Set timeout to hide loading if translation takes too long
      this.translationTimeout = setTimeout(() => {
        if (this.isTranslating) {
          this.hideLoading();
        }
      }, 5000);
    },
    
    applyTranslation: function() {
      if (!this.currentLanguage || this.currentLanguage === this.originalLanguage) {
        this.hideLoading();
        return;
      }
      
      // Try multiple methods to apply translation
      
      // Method 1: Using the dropdown
      const selectElement = document.querySelector('.goog-te-combo');
      if (selectElement) {
        selectElement.value = this.currentLanguage;
        const event = new Event('change', { bubbles: true });
        selectElement.dispatchEvent(event);
      }
      
      // Method 2: Using cookies
      const domain = window.location.hostname;
      document.cookie = `googtrans=/auto/${this.currentLanguage}; domain=${domain}; path=/;`;
      document.cookie = `googtrans=/auto/${this.currentLanguage}; domain=.${domain}; path=/;`;
      
      // Method 3: Using direct API if available
      if (window.google && window.google.translate && window.google.translate.TranslateElement) {
        try {
          const te = google.translate.TranslateElement.getInstance();
          if (te) {
            te.selectLanguage(this.currentLanguage);
          }
        } catch (e) {
          console.log('Direct translation method failed, using alternatives');
        }
      }
      
      // Monitor DOM for translation changes
      this.monitorTranslationChanges();
    },
    
    monitorTranslationChanges: function() {
      // Check for translation immediately
      const checkTranslation = () => {
        // Various indicators that translation has occurred
        const isTranslated = 
          document.body.classList.contains('translated-ltr') || 
          document.body.classList.contains('translated-rtl') ||
          document.documentElement.classList.contains('translated-ltr') ||
          document.documentElement.classList.contains('translated-rtl') ||
          document.cookie.includes('googtrans') ||
          document.querySelector('.goog-te-banner-frame') !== null ||
          document.querySelector('.skiptranslate') !== null;
        
        if (isTranslated) {
          this.hideLoading();
          return true;
        }
        return false;
      };
      
      // If translation detected immediately
      if (checkTranslation()) return;
      
      // Set up a mutation observer to detect when translation happens
      const translationObserver = new MutationObserver((mutations) => {
        if (checkTranslation()) {
          translationObserver.disconnect();
        }
      });
      
      translationObserver.observe(document.documentElement, {
        attributes: true,
        childList: true,
        subtree: true,
        attributeFilter: ['class']
      });
      
      // Fallback: hide loading after 3 seconds anyway
      setTimeout(() => {
        this.hideLoading();
        translationObserver.disconnect();
      }, 3000);
    },
    
    resetToOriginal: function() {
      // Clear translation cookies
      const domain = window.location.hostname;
      document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; domain=${domain}; path=/;`;
      document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; domain=.${domain}; path=/;`;
      document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
      
      // Force reload to clear translation (most reliable method)
      location.reload();
    },
    
    setupEventListeners: function() {
      // Listen for localStorage changes
      window.addEventListener('storage', (e) => {
        if (e.key === 'preferredLanguage') {
          const newLanguage = e.newValue;
          
          // Only process if language actually changed
          if (newLanguage !== this.currentLanguage) {
            this.currentLanguage = newLanguage;
            
            if (newLanguage && newLanguage !== this.originalLanguage) {
              this.showLoading();
              // If Google Translate already loaded, apply directly
              if (window.google && window.google.translate) {
                this.applyTranslation();
              } else {
                this.loadGoogleTranslateScript();
              }
            } else {
              this.resetToOriginal();
            }
          }
        }
      });
      
      // Listen for color preferences for loading dots
      window.addEventListener('storage', (e) => {
        if (e.key === 'color-value' && e.newValue) {
          const dots = document.querySelectorAll('.language-loading-dot');
          dots.forEach(dot => {
            dot.style.backgroundColor = e.newValue;
          });
        }
      });
      
      // Check for color preference immediately
      const savedColor = localStorage.getItem('color-value');
      if (savedColor) {
        const dots = document.querySelectorAll('.language-loading-dot');
        dots.forEach(dot => {
          dot.style.backgroundColor = savedColor;
        });
      }
      
      // Handle page visibility changes to manage translation UI
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && this.currentLanguage && this.currentLanguage !== this.originalLanguage) {
          this.setupTranslateElementHider();
        }
      });
      
      // Handle after page loads completely
      window.addEventListener('load', () => {
        // Re-hide elements after page is fully loaded
        setTimeout(() => this.setupTranslateElementHider(), 500);
      });
    },
    
    showLoading: function() {
      this.isTranslating = true;
      const overlay = document.querySelector('.language-loading-overlay');
      if (overlay) overlay.classList.add('active');
      
      // Clear any existing timeout
      if (this.translationTimeout) {
        clearTimeout(this.translationTimeout);
      }
    },
    
    hideLoading: function() {
      this.isTranslating = false;
      const overlay = document.querySelector('.language-loading-overlay');
      if (overlay) overlay.classList.remove('active');
      
      // Additional cleaning to hide Google elements
      setTimeout(() => this.setupTranslateElementHider(), 100);
      
      // Clear any existing timeout
      if (this.translationTimeout) {
        clearTimeout(this.translationTimeout);
        this.translationTimeout = null;
      }
    }
  };
  
  // Initialize immediately
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => LanguageSyncManager.initialize());
  } else {
    LanguageSyncManager.initialize();
  }
})();

</script>
<script>
// Font size synchronization script
(function() {
    // Function to apply font size from localStorage
    function applyFontSize() {
        const size = localStorage.getItem('font-size') || '1';
        document.body.style.fontSize = size + 'rem';
        
        // Add scaling to different elements if needed
        const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const paragraphs = document.querySelectorAll('p');
        const buttons = document.querySelectorAll('button');
        const inputs = document.querySelectorAll('input');
        
        headings.forEach(heading => {
            const currentSize = window.getComputedStyle(heading).fontSize;
            const baseSize = parseFloat(currentSize) / 16; // convert to rem
            heading.style.fontSize = (baseSize * parseFloat(size)) + 'rem';
        });
        
        paragraphs.forEach(p => {
            p.style.fontSize = size + 'rem';
        });
        
        buttons.forEach(button => {
            button.style.fontSize = (parseFloat(size) * 0.9) + 'rem';
        });
        
        inputs.forEach(input => {
            input.style.fontSize = size + 'rem';
        });
    }
    
    // Apply immediately
    applyFontSize();
    
    // Listen for changes
    window.addEventListener('storage', function(event) {
        if (event.key === 'font-size') {
            applyFontSize();
        }
    });
    
    // Check every second for changes (backup method)
    setInterval(function() {
        const currentSize = document.body.style.fontSize;
        const savedSize = localStorage.getItem('font-size') || '1';
        
        if (currentSize !== savedSize + 'rem') {
            applyFontSize();
        }
    }, 1000);
})();
</script>
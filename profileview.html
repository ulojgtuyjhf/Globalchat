
<!DOCTYPE html>
<html>
<head>
    <title>Profile Settings</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <style>
        :root {
            --twitter-bg: #ffffff;
            --twitter-card: #f7f9fa;
            --twitter-line: #ebeef0;
            --twitter-blue: #1da1f2;
            --twitter-light-blue: #1a91da;
            --twitter-text: #14171a;
            --twitter-secondary-text: #657786;
            --twitter-border: #ebeef0;
            --twitter-hover: rgba(29, 161, 242, 0.1);
            --twitter-button: #1da1f2;
            --twitter-button-hover: #1a91da;
            --twitter-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--twitter-bg);
            color: var(--twitter-text);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--twitter-bg);
        }

        .header {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            position: sticky;
            top: 0;
            background: var(--twitter-bg);
            z-index: 10;
        }

        .back-button {
            color: var(--twitter-blue);
            font-size: 20px;
            margin-right: 20px;
            cursor: pointer;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
        }

        .settings-list {
            padding: 10px 0;
        }

        .settings-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .settings-item:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .settings-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--twitter-blue);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            color: white;
        }

        .settings-icon i {
            font-size: 15px;
        }

        .settings-item-content {
            flex-grow: 1;
        }

        .settings-item-title {
            font-weight: bold;
            color: var(--twitter-text);
            margin-bottom: 3px;
        }

        .settings-item-subtitle {
            color: var(--twitter-secondary-text);
            font-size: 14px;
        }

        .settings-item-right {
            color: var(--twitter-secondary-text);
            margin-left: 10px;
        }

        .profile-header {
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            background: var(--twitter-bg);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .profile-header.sticky {
            position: sticky;
            top: 0;
            z-index: 5;
            box-shadow: var(--twitter-shadow);
        }

        .profile-info {
            display: flex;
            align-items: center;
        }

        .profile-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--twitter-blue);
            margin-right: 15px;
            cursor: pointer;
        }

        .profile-name-container {
            flex-grow: 1;
        }

        .profile-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--twitter-text);
            margin-bottom: 3px;
        }

        .profile-email {
            color: var(--twitter-secondary-text);
            font-size: 14px;
            display: none;
        }

        .profile-stats {
            display: flex;
            margin-top: 15px;
        }

        .profile-stat {
            margin-right: 20px;
            cursor: pointer;
        }

        .profile-stat-number {
            font-weight: bold;
            color: var(--twitter-text);
        }

        .profile-stat-label {
            color: var(--twitter-secondary-text);
            font-size: 13px;
        }

        /* Edit Profile Page */
        .edit-profile-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--twitter-bg);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .edit-profile-container.active {
            transform: translateX(0);
        }

        .edit-profile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
        }

        .edit-profile-title {
            font-size: 18px;
            font-weight: bold;
        }

        .cancel-button, .save-button {
            background: none;
            border: none;
            color: var(--twitter-blue);
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        .save-button {
            background: var(--twitter-blue);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .save-button:hover {
            background: var(--twitter-light-blue);
        }

        .edit-profile-image-container {
            position: relative;
            width: 100%;
            height: 160px;
            background: var(--twitter-card);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .edit-profile-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--twitter-bg);
        }

        .edit-profile-camera-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .edit-profile-form {
            padding: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--twitter-secondary-text);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: var(--twitter-card);
            border: 1px solid var(--twitter-line);
            border-radius: 5px;
            color: var(--twitter-text);
            font-size: 16px;
        }

        .form-input:focus {
            border-color: var(--twitter-blue);
            outline: none;
        }

        .form-textarea {
            resize: none;
            height: 100px;
        }

        .character-count {
            text-align: right;
            color: var(--twitter-secondary-text);
            font-size: 14px;
            margin-top: 5px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccd6dd;
            border-radius: 12px;
            cursor: pointer;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle-switch.active {
            background: var(--twitter-blue);
        }

        .toggle-switch.active::before {
            transform: translateX(26px);
        }

        /* Followers Modal */
        .follow-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--twitter-bg);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .follow-screen.active {
            transform: translateX(0);
        }

        .follow-header {
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            display: flex;
            align-items: center;
            background: var(--twitter-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .follow-back {
            margin-right: 20px;
            font-size: 20px;
            color: var(--twitter-blue);
            cursor: pointer;
        }

        .follow-title {
            font-size: 18px;
            font-weight: bold;
        }

        .follow-body {
            flex: 1;
            overflow-y: auto;
        }

        .user-list-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--twitter-line);
            transition: background 0.2s ease;
        }

        .user-list-item:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .user-list-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 1px solid var(--twitter-line);
        }

        .user-list-item-info {
            flex-grow: 1;
        }

        .user-list-item-name {
            font-weight: bold;
            color: var(--twitter-text);
        }

        .user-list-item-username {
            color: var(--twitter-secondary-text);
            font-size: 14px;
        }

        .follow-button {
            background: var(--twitter-blue);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .follow-button:hover {
            background: var(--twitter-light-blue);
        }

        .following-button {
            background: transparent;
            color: var(--twitter-text);
            border: 1px solid var(--twitter-border);
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .following-button:hover {
            background: rgba(224, 36, 94, 0.1);
            color: #e0245e;
            border-color: rgba(224, 36, 94, 0.2);
        }

        .following-button:hover .follow-text {
            display: none;
        }

        .following-button:hover .unfollow-text {
            display: inline;
        }

        .unfollow-text {
            display: none;
            color: #e0245e;
        }

        .no-results {
            padding: 40px 20px;
            text-align: center;
            color: var(--twitter-secondary-text);
            font-size: 16px;
        }

        .dark-mode {
            --twitter-bg: #15202b;
            --twitter-card: #192734;
            --twitter-line: #38444d;
            --twitter-text: #ffffff;
            --twitter-secondary-text: #8899a6;
            --twitter-border: #38444d;
            --twitter-hover: rgba(29, 161, 242, 0.1);
            --twitter-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--twitter-blue);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Settings Screen -->
        <div class="header">
            <div class="header-title">Settings</div>
        </div>

        <div class="profile-header" id="profileSection">
            <div class="profile-info">
                <img id="profileImage" src="default-profile.png" alt="Profile" class="profile-image">
                <div class="profile-name-container">
                    <div id="profileName" class="profile-name">User Name</div>
                    <div id="profileEmail" class="profile-email">user@example.com</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
            <div class="profile-stats">
                <div class="profile-stat" id="followersBtn">
                    <span id="followersCount" class="profile-stat-number">0</span>
                    <span class="profile-stat-label">Followers</span>
                </div>
                <div class="profile-stat" id="followingBtn">
                    <span id="followingCount" class="profile-stat-number">0</span>
                    <span class="profile-stat-label">Following</span>
                </div>
            </div>
        </div>

        <div class="settings-list">
            <div class="settings-item" id="accountBtn">
                <div class="settings-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Account</div>
                    <div class="settings-item-subtitle">Security notifications, change number</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="privacyBtn">
                <div class="settings-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Privacy</div>
                    <div class="settings-item-subtitle">Block contacts, disappearing messages</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="chatsBtn">
                <div class="settings-icon">
                    <i class="fas fa-comment"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Chats</div>
                    <div class="settings-item-subtitle">Theme, wallpapers, chat history</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="notificationsBtn">
                <div class="settings-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Notifications</div>
                    <div class="settings-item-subtitle">Message, group & call tones</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="storageBtn">
                <div class="settings-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Storage and data</div>
                    <div class="settings-item-subtitle">Network usage, auto-download</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="darkModeBtn">
                <div class="settings-icon">
                    <i class="fas fa-moon"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Dark Mode</div>
                    <div class="settings-item-subtitle">Toggle dark/light theme</div>
                </div>
                <div class="settings-item-right">
                    <div class="toggle-switch" id="darkModeSwitch"></div>
                </div>
            </div>

            <div class="settings-item" id="helpBtn">
                <div class="settings-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Help</div>
                    <div class="settings-item-subtitle">Help center, contact us</div>
                </div>
                <div class="settings-item-right">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="settings-item" id="logoutBtn">
                <div class="settings-icon" style="background: #e0245e;">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <div class="settings-item-content">
                    <div class="settings-item-title">Logout</div>
                    <div class="settings-item-subtitle">Log out from your account</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Screen -->
    <div class="edit-profile-container" id="editProfileContainer">
        <div class="edit-profile-header">
            <button class="cancel-button" id="cancelEditProfile">Cancel</button>
            <div class="edit-profile-title">Edit profile</div>
            <button class="save-button" id="saveProfileBtn">Save</button>
        </div>

        <div class="edit-profile-image-container">
            <img id="editProfileImage" src="default-profile.png" alt="Profile" class="edit-profile-image">
            <div class="edit-profile-camera-icon" id="changeProfilePicture">
                <i class="fas fa-camera"></i>
                <input type="file" id="profilePictureInput" style="display:none" accept="image/*">
            </div>
        </div>

        <div class="edit-profile-form">
            <div class="form-group">
                <label class="form-label" for="nameInput">Name</label>
                <input type="text" id="nameInput" class="form-input" placeholder="Add your name">
            </div>

            <div class="form-group">
                <label class="form-label" for="bioInput">Bio</label>
                <textarea id="bioInput" class="form-input form-textarea" placeholder="Add a bio to tell people about yourself" maxlength="150"></textarea>
                <div class="character-count"><span id="bioCharCount">0</span>/150</div>
            </div>

            <div class="form-group">
                <label class="form-label" for="emailDisplay">Email</label>
                <div id="emailDisplay" class="form-input" style="background: var(--twitter-card); opacity: 0.7;"></div>
            </div>
        </div>
    </div>

    <!-- Followers Screen -->
    <div class="follow-screen" id="followersScreen">
        <div class="follow-header">
            <div class="follow-back" id="closeFollowers">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="follow-title" id="followScreenTitle">Followers</div>
        </div>
        <div class="follow-body" id="followersBody">
            <!-- User list will be populated here -->
        </div>
    </div>

    <!-- Following Screen -->
    <div class="follow-screen" id="followingScreen">
        <div class="follow-header">
            <div class="follow-back" id="closeFollowing">
                <i class="fas fa-arrow-left"></i>
            </div>
            <div class="follow-title">Following</div>
        </div>
        <div class="follow-body" id="followingBody">
            <!-- User list will be populated here -->
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>



<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDnPz8BWCaXJOazlFVO4Eap8VxdSR2oDFQ",
        authDomain: "globalchat-2d669.firebaseapp.com",
        projectId: "globalchat-2d669",
        storageBucket: "globalchat-2d669.appspot.com",
        messagingSenderId: "178714711978",
        appId: "1:178714711978:web:fb831188be23e62a4bbdd3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM Elements - Main Settings
    const profileSection = document.getElementById('profileSection');
    const profileImage = document.getElementById('profileImage');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');
    const followersCount = document.getElementById('followersCount');
    const followingCount = document.getElementById('followingCount');
    const followersBtn = document.getElementById('followersBtn');
    const followingBtn = document.getElementById('followingBtn');
    const darkModeSwitch = document.getElementById('darkModeSwitch');
    const logoutBtn = document.getElementById('logoutBtn');

    // DOM Elements - Edit Profile
    const editProfileContainer = document.getElementById('editProfileContainer');
    const cancelEditProfile = document.getElementById('cancelEditProfile');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const editProfileImage = document.getElementById('editProfileImage');
    const changeProfilePicture = document.getElementById('changeProfilePicture');
    const profilePictureInput = document.getElementById('profilePictureInput');
    const nameInput = document.getElementById('nameInput');
    const bioInput = document.getElementById('bioInput');
    const bioCharCount = document.getElementById('bioCharCount');
    const emailDisplay = document.getElementById('emailDisplay');

    // DOM Elements - Followers/Following Screen
    const followersScreen = document.getElementById('followersScreen');
    const followingScreen = document.getElementById('followingScreen');
    const closeFollowers = document.getElementById('closeFollowers');
    const closeFollowing = document.getElementById('closeFollowing');
    const followersBody = document.getElementById('followersBody');
    const followingBody = document.getElementById('followingBody');

    // DOM Elements - Toast
    const toast = document.getElementById('toast');

    // Settings page buttons
    const accountBtn = document.getElementById('accountBtn');
    const privacyBtn = document.getElementById('privacyBtn');
    const chatsBtn = document.getElementById('chatsBtn');
    const notificationsBtn = document.getElementById('notificationsBtn');
    const storageBtn = document.getElementById('storageBtn');
    const helpBtn = document.getElementById('helpBtn');
    
    // Function to show toast notifications
    function showToast(message, duration = 2000) {
        toast.textContent = message;
        toast.classList.add('active');
        
        setTimeout(() => {
            toast.classList.remove('active');
        }, duration);
    }

    // Loading Animation
    function showLoading() {
        const loadingToast = document.createElement('div');
        loadingToast.id = 'loadingToast';
        loadingToast.className = 'toast active';
        loadingToast.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        document.body.appendChild(loadingToast);
        return loadingToast;
    }

    function hideLoading(loadingElement) {
        if (loadingElement) {
            loadingElement.remove();
        }
    }

    // Sticky Profile Header
    function initializeStickyHeader() {
        const header = document.querySelector('.header');
        const headerHeight = header.offsetHeight;
        
        window.addEventListener('scroll', () => {
            if (window.scrollY > headerHeight) {
                profileSection.classList.add('sticky');
            } else {
                profileSection.classList.remove('sticky');
            }
        });
    }

    // Dark Mode Toggle - Now using localStorage
    function initializeDarkMode() {
        // Check localStorage for dark mode preference
        const isDarkMode = localStorage.getItem('darkMode') === 'enabled';
        
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            darkModeSwitch.classList.add('active');
        } else {
            document.body.classList.remove('dark-mode');
            darkModeSwitch.classList.remove('active');
        }

        darkModeSwitch.addEventListener('click', function() {
            this.classList.toggle('active');
            document.body.classList.toggle('dark-mode');
            
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
            } else {
                localStorage.setItem('darkMode', 'disabled');
            }
        });
    }

    // Toggle Edit Profile
    function initializeEditProfile() {
        profileSection.addEventListener('click', () => {
            editProfileContainer.classList.add('active');
        });

        cancelEditProfile.addEventListener('click', () => {
            editProfileContainer.classList.remove('active');
        });
    }

    // Profile Picture Change with local storage
    function initializeProfilePictureChange(user) {
        // Set initial profile picture from localStorage if available
        const cachedProfilePic = localStorage.getItem(`profilePic_${user.uid}`);
        if (cachedProfilePic) {
            profileImage.src = cachedProfilePic;
            editProfileImage.src = cachedProfilePic;
        }

        changeProfilePicture.addEventListener('click', () => {
            profilePictureInput.click();
        });

        profilePictureInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const loadingToast = showLoading();
                    
                    // Convert image to base64 for localStorage
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const base64Image = event.target.result;
                        
                        // Save to localStorage
                        localStorage.setItem(`profilePic_${user.uid}`, base64Image);
                        
                        // Preview the image
                        profileImage.src = base64Image;
                        editProfileImage.src = base64Image;
                        
                        // Also upload to Firebase storage for persistence
                        try {
                            const storageRef = ref(storage, `profilePictures/${user.uid}`);
                            const snapshot = await uploadBytes(storageRef, file);
                            const photoURL = await getDownloadURL(snapshot.ref);
                            
                            // Update user profile in Firebase Auth
                            await updateProfile(user, { photoURL: photoURL });
                            
                            // Update user document in Firestore
                            const userDocRef = doc(db, 'users', user.uid);
                            await updateDoc(userDocRef, { photoURL: photoURL });
                            
                            hideLoading(loadingToast);
                            showToast('Profile picture updated!');
                        } catch (error) {
                            console.error('Error uploading to Firebase:', error);
                            hideLoading(loadingToast);
                            // We still have the local version, so just show a partial success
                            showToast('Profile picture updated locally!');
                        }
                    };
                    
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error processing image:', error);
                    showToast('Failed to update image. Please try again.');
                }
            }
        });
    }

    // Bio Input Character Count
    function initializeBioCharCount() {
        bioInput.addEventListener('input', () => {
            const count = bioInput.value.length;
            bioCharCount.textContent = count;
        });
    }

    // Save Profile Changes with local storage
    async function saveProfileChanges(user) {
        const loadingToast = showLoading();
        const newName = nameInput.value.trim();
        const newBio = bioInput.value.trim();
        const photoURL = editProfileImage.src;

        try {
            // Save to localStorage
            localStorage.setItem(`displayName_${user.uid}`, newName);
            localStorage.setItem(`bio_${user.uid}`, newBio);
            
            // Update UI immediately
            profileName.textContent = newName;
            
            // Update auth profile
            await updateProfile(user, { 
                displayName: newName,
                photoURL: photoURL === 'default-profile.png' ? null : photoURL
            });

            // Update firestore document
            await updateDoc(doc(db, 'users', user.uid), {
                displayName: newName,
                bio: newBio,
                photoURL: photoURL === 'default-profile.png' ? null : photoURL
            });

            editProfileContainer.classList.remove('active');
            hideLoading(loadingToast);
            showToast('Profile updated successfully!');
        } catch (error) {
            console.error('Error updating profile:', error);
            hideLoading(loadingToast);
            // We still updated locally, so show partial success
            showToast('Profile updated locally. Some changes may not sync.');
            editProfileContainer.classList.remove('active');
        }
    }

    // Fetch Follow Data with caching
    async function fetchFollowData(user) {
        // Check localStorage first
        const cachedFollowersCount = localStorage.getItem(`followersCount_${user.uid}`);
        const cachedFollowingCount = localStorage.getItem(`followingCount_${user.uid}`);
        
        if (cachedFollowersCount) {
            followersCount.textContent = cachedFollowersCount;
        }
        
        if (cachedFollowingCount) {
            followingCount.textContent = cachedFollowingCount;
        }
        
        try {
            // Fetch followers count
            const followersQuery = query(collection(db, 'follows'), 
                where('followedUserId', '==', user.uid)
            );
            const followersSnapshot = await getDocs(followersQuery);
            followersCount.textContent = followersSnapshot.size;
            localStorage.setItem(`followersCount_${user.uid}`, followersSnapshot.size);

            // Fetch following count
            const followingQuery = query(collection(db, 'follows'), 
                where('followerUserId', '==', user.uid)
            );
            const followingSnapshot = await getDocs(followingQuery);
            followingCount.textContent = followingSnapshot.size;
            localStorage.setItem(`followingCount_${user.uid}`, followingSnapshot.size);
        } catch (error) {
            console.error('Error fetching follow data:', error);
            // We'll keep using the cached data if it exists
        }
    }

    // Initialize Followers/Following Screen
    function initializeFollowScreens(user) {
        // Followers screen
        followersBtn.addEventListener('click', async () => {
            followersBody.innerHTML = '';
            followersScreen.classList.add('active');
            
            const loadingToast = showLoading();
            
            try {
                // Check localStorage for cached followers list
                const cachedFollowers = localStorage.getItem(`followersList_${user.uid}`);
                
                if (cachedFollowers) {
                    followersBody.innerHTML = cachedFollowers;
                } else {
                    followersBody.innerHTML = '<div class="no-results">Loading followers...</div>';
                }
                
                const followersQuery = query(collection(db, 'follows'), 
                    where('followedUserId', '==', user.uid)
                );
                const followersSnapshot = await getDocs(followersQuery);
                
                if (followersSnapshot.empty) {
                    followersBody.innerHTML = '<div class="no-results">No followers yet</div>';
                    localStorage.setItem(`followersList_${user.uid}`, followersBody.innerHTML);
                } else {
                    let followersHTML = '';
                    
                    for (const followDoc of followersSnapshot.docs) {
                        const followerData = followDoc.data();
                        const followerUserDoc = await getDoc(doc(db, 'users', followerData.followerUserId));
                        
                        if (followerUserDoc.exists()) {
                            const userData = followerUserDoc.data();
                            followersHTML += `
                                <div class="user-list-item">
                                    <img src="${userData.photoURL || 'default-profile.png'}" alt="Profile">
                                    <div class="user-list-item-info">
                                        <div class="user-list-item-name">${userData.displayName || 'User'}</div>
                                        <div class="user-list-item-username">@${userData.displayName?.toLowerCase().replace(/\s/g, '') || 'user'}</div>
                                    </div>
                                    <button class="follow-button">Follow</button>
                                </div>
                            `;
                        }
                    }
                    
                    followersBody.innerHTML = followersHTML;
                    localStorage.setItem(`followersList_${user.uid}`, followersHTML);
                }
                
                hideLoading(loadingToast);
            } catch (error) {
                console.error('Error fetching followers:', error);
                followersBody.innerHTML = '<div class="no-results">Error loading followers</div>';
                hideLoading(loadingToast);
            }
        });

        // Following screen
        followingBtn.addEventListener('click', async () => {
            followingBody.innerHTML = '';
            followingScreen.classList.add('active');
            
            const loadingToast = showLoading();
            
            try {
                // Check localStorage for cached following list
                const cachedFollowing = localStorage.getItem(`followingList_${user.uid}`);
                
                if (cachedFollowing) {
                    followingBody.innerHTML = cachedFollowing;
                } else {
                    followingBody.innerHTML = '<div class="no-results">Loading following...</div>';
                }
                
                const followingQuery = query(collection(db, 'follows'), 
                    where('followerUserId', '==', user.uid)
                );
                const followingSnapshot = await getDocs(followingQuery);
                
                if (followingSnapshot.empty) {
                    followingBody.innerHTML = '<div class="no-results">Not following anyone yet</div>';
                    localStorage.setItem(`followingList_${user.uid}`, followingBody.innerHTML);
                } else {
                    let followingHTML = '';
                    
                    for (const followDoc of followingSnapshot.docs) {
                        const followingData = followDoc.data();
                        const followedUserDoc = await getDoc(doc(db, 'users', followingData.followedUserId));
                        
                        if (followedUserDoc.exists()) {
                            const userData = followedUserDoc.data();
                            followingHTML += `
                                <div class="user-list-item">
                                    <img src="${userData.photoURL || 'default-profile.png'}" alt="Profile">
                                    <div class="user-list-item-info">
                                        <div class="user-list-item-name">${userData.displayName || 'User'}</div>
                                        <div class="user-list-item-username">@${userData.displayName?.toLowerCase().replace(/\s/g, '') || 'user'}</div>
                                    </div>
                                    <button class="following-button">
                                        <span class="follow-text">Following</span>
                                        <span class="unfollow-text">Unfollow</span>
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                    followingBody.innerHTML = followingHTML;
                    localStorage.setItem(`followingList_${user.uid}`, followingHTML);
                }
                
                hideLoading(loadingToast);
            } catch (error) {
                console.error('Error fetching following:', error);
                followingBody.innerHTML = '<div class="no-results">Error loading following</div>';
                hideLoading(loadingToast);
            }
        });

        // Close buttons
        closeFollowers.addEventListener('click', () => {
            followersScreen.classList.remove('active');
        });
        
        closeFollowing.addEventListener('click', () => {
            followingScreen.classList.remove('active');
        });
    }

    // Initialize Settings Buttons - updated to load pages
    function initializeSettingsButtons() {
        // Map of button IDs to their respective pages
        const settingsPageMap = {
            'accountBtn': 'account.html',
            'privacyBtn': 'privacy.html',
            'chatsBtn': 'chats.html',
            'notificationsBtn': 'notifications.html',
            'storageBtn': 'storage.html',
            'helpBtn': 'help.html'
        };
        
        for (const [buttonId, pagePath] of Object.entries(settingsPageMap)) {
            const button = document.getElementById(buttonId);
            
            if (button) {
                button.addEventListener('click', () => {
                    const loadingToast = showLoading();
                    
                    // Simulate page loading
                    setTimeout(() => {
                        hideLoading(loadingToast);
                        
                        // For now, just show a toast instead of redirecting
                        const title = button.querySelector('.settings-item-title').textContent;
                        showToast(`${title} settings would load ${pagePath}`);
                    }, 500);
                });
            }
        }
    }

    // Logout
    function initializeLogout() {
        logoutBtn.addEventListener('click', async () => {
            const loadingToast = showLoading();
            
            try {
                await signOut(auth);
                hideLoading(loadingToast);
                window.location.href = 'login.html'; // Redirect to login page
            } catch (error) {
                console.error('Logout error:', error);
                hideLoading(loadingToast);
                showToast('Failed to log out. Please try again.');
            }
        });
    }

    // Page Animation
    function initializePageAnimation() {
        document.body.style.opacity = '0';
        setTimeout(() => {
            document.body.style.transition = 'opacity 0.3s ease';
            document.body.style.opacity = '1';
        }, 100);
    }

    // Load user data from local storage first, then update from Firestore
    async function loadUserData(user) {
        // Check if we have cached data in localStorage
        const cachedName = localStorage.getItem(`displayName_${user.uid}`);
        const cachedBio = localStorage.getItem(`bio_${user.uid}`);
        const cachedProfilePic = localStorage.getItem(`profilePic_${user.uid}`);
        
        // Apply cached data first for instant loading
        if (cachedName) {
            profileName.textContent = cachedName;
            nameInput.value = cachedName;
        } else {
            profileName.textContent = user.displayName || 'User';
            nameInput.value = user.displayName || '';
        }
        
        if (cachedBio) {
            bioInput.value = cachedBio;
            bioCharCount.textContent = cachedBio.length;
        }
        
        if (cachedProfilePic) {
            profileImage.src = cachedProfilePic;
            editProfileImage.src = cachedProfilePic;
        } else if (user.photoURL) {
            profileImage.src = user.photoURL;
            editProfileImage.src = user.photoURL;
        } else {
            profileImage.src = 'default-profile.png';
            editProfileImage.src = 'default-profile.png';
        }
        
        emailDisplay.textContent = user.email || '';
        
        // Then fetch latest data from Firestore in background
        try {
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                
                // Update localStorage with latest data
                localStorage.setItem(`displayName_${user.uid}`, userData.displayName || user.displayName || 'User');
                localStorage.setItem(`bio_${user.uid}`, userData.bio || '');
                
                if (userData.photoURL) {
                    localStorage.setItem(`profilePic_${user.uid}`, userData.photoURL);
                }
                
                // Update UI with latest data
                profileName.textContent = userData.displayName || user.displayName || 'User';
                nameInput.value = userData.displayName || user.displayName || '';
                bioInput.value = userData.bio || '';
                bioCharCount.textContent = (userData.bio || '').length;
                
                if (userData.photoURL) {
                    profileImage.src = userData.photoURL;
                    editProfileImage.src = userData.photoURL;
                }
            } else {
                // Create user document if it doesn't exist
                const userData = {
                    displayName: user.displayName || cachedName || 'User',
                    email: user.email,
                    photoURL: user.photoURL || cachedProfilePic || null,
                    bio: cachedBio || '',
                    createdAt: new Date()
                };
                
                await updateDoc(doc(db, 'users', user.uid), userData);
            }
        } catch (error) {
            console.error('Error fetching user data from Firestore:', error);
            // Continue with cached data
        }
    }

    // Authentication State Observer
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Show loading indicator
            const loadingToast = showLoading();
            
            try {
                // Load user data (with local storage prioritized)
                await loadUserData(user);
                
                // Initialize all functionality
                initializeStickyHeader();
                initializeDarkMode();
                initializeEditProfile();
                initializeProfilePictureChange(user);
                initializeBioCharCount();
                initializeFollowScreens(user);
                initializeSettingsButtons();
                initializeLogout();
                fetchFollowData(user);
                initializePageAnimation();

                // Save profile changes event
                saveProfileBtn.addEventListener('click', () => saveProfileChanges(user));
                
                hideLoading(loadingToast);
            } catch (error) {
                console.error('Error initializing app:', error);
                hideLoading(loadingToast);
                showToast('An error occurred while loading your profile');
            }
        } else {
            // Redirect to login if not authenticated
            window.location.href = 'login.html';
        }
    });

    // Handle follow/unfollow actions
    document.addEventListener('click', async (e) => {
        const user = auth.currentUser;
        if (!user) return;

        // Handle follow button clicks
        if (e.target.classList.contains('follow-button')) {
            const loadingToast = showLoading();
            const userItem = e.target.closest('.user-list-item');
            const username = userItem.querySelector('.user-list-item-username').textContent.substring(1); // Remove @ symbol
            
            try {
                // In a real app, you would implement the follow logic here
                // For now, just change the button
                e.target.textContent = 'Following';
                e.target.classList.remove('follow-button');
                e.target.classList.add('following-button');
                
                // Update counts (in a real app this would happen after successful database update)
                const currentCount = parseInt(followingCount.textContent);
                followingCount.textContent = currentCount + 1;
                localStorage.setItem(`followingCount_${user.uid}`, currentCount + 1);
                
                hideLoading(loadingToast);
                showToast(`You are now following ${username}`);
            } catch (error) {
                console.error('Error following user:', error);
                hideLoading(loadingToast);
                showToast('Failed to follow user. Please try again.');
            }
        }
        
        // Handle unfollow (on following-button)
        if (e.target.classList.contains('following-button') || 
            e.target.parentElement.classList.contains('following-button')) {
            
            const loadingToast = showLoading();
            const userItem = e.target.closest('.user-list-item');
            const username = userItem.querySelector('.user-list-item-username').textContent.substring(1);
            
            try {
                // In a real app, you would implement the unfollow logic here
                const button = e.target.classList.contains('following-button') ? 
                    e.target : e.target.parentElement;
                
                button.innerHTML = 'Follow';
                button.classList.remove('following-button');
                button.classList.add('follow-button');
                
                // Update counts (in a real app this would happen after successful database update)
                const currentCount = parseInt(followingCount.textContent);
                if (currentCount > 0) {
                    followingCount.textContent = currentCount - 1;
                    localStorage.setItem(`followingCount_${user.uid}`, currentCount - 1);
                }
                
                hideLoading(loadingToast);
                showToast(`You have unfollowed ${username}`);
            } catch (error) {
                console.error('Error unfollowing user:', error);
                hideLoading(loadingToast);
                showToast('Failed to unfollow user. Please try again.');
            }
        }
    });
</script>

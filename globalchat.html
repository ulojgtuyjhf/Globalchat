<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="chat.css">
  <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/chatnot-e5b4e.firebasestorage.app/o/Black%20and%20Blue%20Initials%20Creative%20Logo_20250214_091517_0000.png?alt=media&token=e420af56-8bd5-4691-b246-b0485c30dccd">
  
  <title>nmedea</title>
</head>
<body>
  <div class="chat-container" id="chatContainer">
    <div class="loading-dots" id="loadingIndicator" style="display: none;">
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>
  </div>
  <div class="input-container">
    <textarea id="messageInput" placeholder="Type your message..."></textarea>
    <button onclick="sendMessage()">
      <img src="https://cdn-icons-png.flaticon.com/512/786/786205.png" alt="Send">
    </button>

  </div>
<script type="module" src="chat.js"></script>
<script src="reply.js"></script>
<script src="replyhighl.js"></script>
<script src="link.js"></script>
<script src="check.js"></script>
<script src="loadfollow.js"></script>
<script src="viewprof.js"></script>
<script src="ad.js"></script>
<script src="mark.js"></script>
<script src="sound.js"></script>
<script src="like.js"></script>
<script src="skelechat.js"></script>
<script src="language.js"></script>
<script src="little.js"></script>
<script src="autoscroll.js"></script>
<script src="remove.js"></script>
<script src="highflk.js"></script>
<script src="vtot.js"></script>
<script src="copy.js"></script>
<script src="backprof.js"></script>
<script src="secchat.js"></script>

<script>
(() => {
  const profileModal = document.querySelector('.profile-modal');
  const content = profileModal.querySelector('.profile-content');
  const profileName = profileModal.querySelector('.profile-name');
  const profileFlag = profileModal.querySelector('.profile-flag');
  const profileImage = profileModal.querySelector('.profile-image');

  // Add full-screen image modal
  const fullScreenImageModal = document.createElement('div');
  fullScreenImageModal.className = 'fullscreen-image-modal';
  fullScreenImageModal.innerHTML = `
    <div class="fullscreen-image-container">
      <img class="fullscreen-image">
    </div>
  `;
  document.body.appendChild(fullScreenImageModal);

  // Enhanced styles for multi-directional dragging
  const imageModalStyles = document.createElement('style');
  imageModalStyles.textContent = `
    .fullscreen-image-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .fullscreen-image-modal.active {
      display: flex;
      opacity: 1;
    }
    
    .fullscreen-image-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      transition: all 0.3s ease;
      cursor: grab;
    }
    
    .fullscreen-image-container.dragging {
      cursor: grabbing;
      transition: none;
    }
    
    .fullscreen-image {
      width: 100%;
      height: auto;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      pointer-events: none;
    }
    
    .country-tooltip {
      position: absolute;
      background: white;
      padding: 8px 16px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-100%);
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1001;
    }
  `;
  document.head.appendChild(imageModalStyles);

  // Country codes to full names mapping
  const countryNames = {
    'af': 'Afghanistan',
    'al': 'Albania',
    'dz': 'Algeria',
    'ad': 'Andorra',
    'ao': 'Angola',
    'ar': 'Argentina',
    'am': 'Armenia',
    'au': 'Australia',
    'at': 'Austria',
    'az': 'Azerbaijan',
    'bs': 'Bahamas',
    'bh': 'Bahrain',
    'bd': 'Bangladesh',
    'bb': 'Barbados',
    'by': 'Belarus',
    'be': 'Belgium',
    'bz': 'Belize',
    'bj': 'Benin',
    'bt': 'Bhutan',
    'bo': 'Bolivia',
    'br': 'Brazil',
    'bn': 'Brunei',
    'bg': 'Bulgaria',
    'ca': 'Canada',
    'cn': 'China',
    'co': 'Colombia',
    'dk': 'Denmark',
    'eg': 'Egypt',
    'fr': 'France',
    'de': 'Germany',
    'gr': 'Greece',
    'in': 'India',
    'id': 'Indonesia',
    'ir': 'Iran',
    'iq': 'Iraq',
    'ie': 'Ireland',
    'il': 'Israel',
    'it': 'Italy',
    'jp': 'Japan',
    'ke': 'Kenya',
    'kr': 'South Korea',
    'kw': 'Kuwait',
    'my': 'Malaysia',
    'mx': 'Mexico',
    'ma': 'Morocco',
    'np': 'Nepal',
    'nl': 'Netherlands',
    'nz': 'New Zealand',
    'ng': 'Nigeria',
    'no': 'Norway',
    'pk': 'Pakistan',
    'ph': 'Philippines',
    'pl': 'Poland',
    'pt': 'Portugal',
    'qa': 'Qatar',
    'ru': 'Russia',
    'sa': 'Saudi Arabia',
    'sg': 'Singapore',
    'za': 'South Africa',
    'es': 'Spain',
    'lk': 'Sri Lanka',
    'se': 'Sweden',
    'ch': 'Switzerland',
    'tw': 'Taiwan',
    'th': 'Thailand',
    'tr': 'Turkey',
    'ae': 'United Arab Emirates',
    'gb': 'United Kingdom',
    'us': 'United States of America',
    'vn': 'Vietnam',
    'ye': 'Yemen',
    'zm': 'Zambia',
    'zw': 'Zimbabwe'
  };

  // Get full country name from flag src
  const getCountryName = (src) => {
    const code = src.split('/').pop().split('.')[0].toLowerCase();
    return countryNames[code] || code.charAt(0).toUpperCase() + code.slice(1);
  };

  // Enhanced drag handling
  let startX = 0;
  let startY = 0;
  let currentX = 0;
  let currentY = 0;
  let isDragging = false;
  let initialTransform = { x: 0, y: 0 };
  const imageContainer = fullScreenImageModal.querySelector('.fullscreen-image-container');

  const handleDragStart = (e) => {
    const touch = e.touches ? e.touches[0] : e;
    startX = touch.clientX;
    startY = touch.clientY;
    isDragging = true;
    imageContainer.classList.add('dragging');
    
    // Store initial transform values
    const transform = window.getComputedStyle(imageContainer).transform;
    const matrix = new DOMMatrix(transform);
    initialTransform = {
      x: matrix.m41,
      y: matrix.m42
    };
  };

  const handleDragMove = (e) => {
    if (!isDragging) return;
    e.preventDefault();
    
    const touch = e.touches ? e.touches[0] : e;
    currentX = touch.clientX;
    currentY = touch.clientY;
    
    const deltaX = currentX - startX;
    const deltaY = currentY - startY;
    
    // Calculate distance from center for scaling
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    const scale = Math.max(0.7, 1 - (distance / window.innerHeight) * 0.3);
    
    // Calculate opacity based on distance
    const opacity = Math.max(0.2, 1 - (distance / window.innerHeight) * 0.8);
    
    imageContainer.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px)) scale(${scale})`;
    fullScreenImageModal.style.background = `rgba(0,0,0,${opacity * 0.95})`;
  };

  const handleDragEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    imageContainer.classList.remove('dragging');
    
    const deltaX = currentX - startX;
    const deltaY = currentY - startY;
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    
    imageContainer.style.transition = 'all 0.3s ease';
    
    // Close if dragged far enough
    if (distance > 100) {
      const angle = Math.atan2(deltaY, deltaX);
      const exitX = Math.cos(angle) * window.innerWidth;
      const exitY = Math.sin(angle) * window.innerHeight;
      
      imageContainer.style.transform = `translate(calc(-50% + ${exitX}px), calc(-50% + ${exitY}px)) scale(0.7)`;
      fullScreenImageModal.style.opacity = '0';
      
      setTimeout(() => {
        fullScreenImageModal.classList.remove('active');
        imageContainer.style.transform = 'translate(-50%, -50%) scale(1)';
        fullScreenImageModal.style.opacity = '1';
        fullScreenImageModal.style.background = 'rgba(0,0,0,0.95)';
      }, 300);
    } else {
      // Spring back to center
      imageContainer.style.transform = 'translate(-50%, -50%) scale(1)';
      fullScreenImageModal.style.background = 'rgba(0,0,0,0.95)';
    }
  };

  // Add touch and mouse event listeners
  if ('ontouchstart' in window) {
    imageContainer.addEventListener('touchstart', handleDragStart);
    imageContainer.addEventListener('touchmove', handleDragMove);
    imageContainer.addEventListener('touchend', handleDragEnd);
  } else {
    imageContainer.addEventListener('mousedown', handleDragStart);
    window.addEventListener('mousemove', handleDragMove);
    window.addEventListener('mouseup', handleDragEnd);
  }

  // Flag tooltip handling
  const showFlagTooltip = (flag) => {
    if (!flag.nextElementSibling?.classList.contains('country-tooltip')) {
      const tooltip = document.createElement('div');
      tooltip.className = 'country-tooltip';
      tooltip.textContent = getCountryName(flag.src);
      
      flag.parentElement.style.position = 'relative';
      flag.parentElement.insertBefore(tooltip, flag.nextSibling);
      
      requestAnimationFrame(() => {
        tooltip.style.opacity = '1';
        tooltip.style.transform = 'translateY(-120%)';
      });
    }
  };

  const hideFlagTooltip = (flag) => {
    const tooltip = flag.nextElementSibling;
    if (tooltip?.classList.contains('country-tooltip')) {
      tooltip.style.opacity = '0';
      tooltip.style.transform = 'translateY(-100%)';
      setTimeout(() => tooltip.remove(), 300);
    }
  };

  // Flag interaction events
  if ('ontouchstart' in window) {
    profileFlag.addEventListener('touchstart', (e) => {
      e.preventDefault();
      showFlagTooltip(e.target);
    });
    
    document.addEventListener('touchstart', (e) => {
      if (!e.target.classList.contains('profile-flag')) {
        hideFlagTooltip(profileFlag);
      }
    });
  } else {
    profileFlag.addEventListener('mouseenter', (e) => showFlagTooltip(e.target));
    profileFlag.addEventListener('mouseleave', (e) => hideFlagTooltip(e.target));
  }

  // Profile image click handler
  profileImage.addEventListener('click', () => {
    const fullscreenImg = fullScreenImageModal.querySelector('.fullscreen-image');
    fullscreenImg.src = profileImage.style.backgroundImage.replace(/url\(['"](.+)['"]\)/, '$1');
    fullScreenImageModal.classList.add('active');
  });

  // Tap to close
  fullScreenImageModal.addEventListener('click', (e) => {
    if (e.target === fullScreenImageModal) {
      fullScreenImageModal.classList.remove('active');
    }
  });

  // Center the profile modal content
  content.style.height = '70vh';
  content.style.maxWidth = '600px';
  content.style.margin = '0 auto';
})();
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Create toggle switch container
    const toggleContainer = document.createElement("div");
    toggleContainer.style.position = "fixed";
    toggleContainer.style.top = "16px";
    toggleContainer.style.left = "18px";
    toggleContainer.style.display = "flex";
    toggleContainer.style.alignItems = "center";
    toggleContainer.style.cursor = "pointer";
    toggleContainer.style.zIndex = "9999"; // Always on top
    toggleContainer.style.padding = "5px 10px";
    toggleContainer.style.background = "rgba(255, 255, 255, 0.8)";
    toggleContainer.style.borderRadius = "20px";
    toggleContainer.style.boxShadow = "2px 2px 8px rgba(0, 0, 0, 0.2)";
    toggleContainer.style.transition = "all 0.3s ease";

    // Label
    const toggleLabel = document.createElement("span");
    toggleLabel.innerText = "Chat";
    toggleLabel.style.fontSize = "16px";
    toggleLabel.style.fontWeight = "bold";
    toggleLabel.style.marginRight = "10px";

    // Toggle switch
    const toggleSwitch = document.createElement("div");
    toggleSwitch.style.width = "50px";
    toggleSwitch.style.height = "25px";
    toggleSwitch.style.borderRadius = "50px";
    toggleSwitch.style.background = "#ddd";
    toggleSwitch.style.position = "relative";
    toggleSwitch.style.transition = "background 0.3s ease";

    // Toggle knob
    const toggleKnob = document.createElement("div");
    toggleKnob.style.width = "23px";
    toggleKnob.style.height = "23px";
    toggleKnob.style.borderRadius = "50%";
    toggleKnob.style.background = "#ffffff";
    toggleKnob.style.position = "absolute";
    toggleKnob.style.top = "1px";
    toggleKnob.style.left = "1px";
    toggleKnob.style.transition = "left 0.3s ease, background 0.3s ease";
    toggleKnob.style.boxShadow = "2px 2px 5px rgba(0,0,0,0.2)";

    toggleSwitch.appendChild(toggleKnob);
    toggleContainer.appendChild(toggleLabel);
    toggleContainer.appendChild(toggleSwitch);
    document.body.appendChild(toggleContainer);

    // Create iframe once
    const iframe = document.createElement("iframe");
    iframe.src = "search.html";
    iframe.style.position = "fixed";
    iframe.style.top = "0";
    iframe.style.left = "0";
    iframe.style.width = "100vw";
    iframe.style.height = "100vh";
    iframe.style.border = "none";
    iframe.style.zIndex = "998";
    iframe.style.display = "none"; // Initially hidden
    document.body.appendChild(iframe);

    // Save the original content of the body (excluding the toggle and iframe)
    const originalContent = Array.from(document.body.children).filter(
      (child) => child !== toggleContainer && child !== iframe
    );

    let isChatVisible = true;

    toggleSwitch.addEventListener("click", function() {
      if (isChatVisible) {
        // Hide original content
        originalContent.forEach((child) => {
          child.style.display = "none";
        });

        // Show iframe
        iframe.style.display = "block";
        toggleSwitch.style.background = "black";
        toggleKnob.style.left = "26px";
        toggleKnob.style.background = "#fff";
        toggleLabel.innerText = "Media";
      } else {
        // Show original content
        originalContent.forEach((child) => {
          child.style.display = "";
        });

        // Hide iframe
        iframe.style.display = "none";
        toggleSwitch.style.background = "#ddd";
        toggleKnob.style.left = "1px";
        toggleKnob.style.background = "#ffffff";
        toggleLabel.innerText = "Chat";
      }
      isChatVisible = !isChatVisible;
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // 1. Create checkmark styling
    const style = document.createElement("style");
    style.textContent = `
      .forced-check {
        display: inline-block;
        width: 14px;
        height: 14px;
        background: black;
        border-radius: 50%;
        margin-left: 4px;
        position: relative;
        z-index: 1;
      }
      .forced-check::after {
        content: "✓";
        color: white;
        font-size: 9px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(15deg);
        font-weight: bold;
      }
    `;
    document.head.appendChild(style);

    // 2. Function to add a checkmark in the correct position
    function addCheckmark(h4) {
      if (!h4.querySelector(".forced-check")) {
        const check = document.createElement("span");
        check.className = "forced-check";

        // Insert after the first text node (username)
        const textNode = Array.from(h4.childNodes).find(n => n.nodeType === Node.TEXT_NODE);
        if (textNode) {
          textNode.parentNode.insertBefore(check, textNode.nextSibling);
        } else {
          h4.appendChild(check);
        }
      }
    }

    // 3. MutationObserver with refined targeting
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (
            node.nodeType === 1 && // Ensure it's an element
            node.classList.contains("message") // Only target messages
          ) {
            const h4 = node.querySelector("h4");
            if (h4) addCheckmark(h4);
          }
        });
      });
    });

    // 4. Observe the chat container if it exists
    const chatContainer = document.getElementById("chatContainer");
    if (chatContainer) {
      observer.observe(chatContainer, { childList: true, subtree: true });
    }
  });
</script>
<script>
  const chatContainer = document.getElementById('chatContainer');

  function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function checkUserScroll() {
    const isAtBottom = chatContainer.scrollHeight - chatContainer.clientHeight <= chatContainer.scrollTop + 10;

    if (isAtBottom) {
      scrollToBottom();
    }
  }

  // Call this function whenever a new message is added
  function onNewMessage() {
    checkUserScroll();
  }

  // Listen for new messages and auto-scroll
  chatContainer.addEventListener('scroll', checkUserScroll);
</script>
<script>
async function moderateAndSendMessage() {
    const messageInput = document.getElementById("messageInput");
    const chatContainer = document.getElementById("chatContainer");

    let messageText = messageInput.value.trim();
    if (!messageText) return;

    try {
        // Request moderation from chatbot API
        const prompt = `Moderate this message and replace any inappropriate content with stars (*****): "${messageText}"`;
        const response = await fetch(`https://darkness.ashlynn.workers.dev/chat/?prompt=${encodeURIComponent(prompt)}&model=claude-3-haiku-20240307`);
        const data = await response.json();

        // Use the chatbot's filtered response
        const filteredMessage = data.response || "Message could not be processed.";

        // Display the moderated message in chat
        const messageElement = document.createElement("div");
        messageElement.classList.add("message");
        messageElement.innerHTML = `<p>${filteredMessage}</p>`;
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // Clear input
        messageInput.value = "";
    } catch (error) {
        console.error("Error:", error);
    }
}

// Attach function to send button
document.querySelector("button").addEventListener("click", moderateAndSendMessage);
</script>